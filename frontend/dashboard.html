<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Whilber-AI | ØªØ­Ù„ÛŒÙ„Ú¯Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø§Ø²Ø§Ø±</title>
<style>
:root{--bg:#0a0c10;--bg2:#12151c;--bg3:#1a1e2a;--bg4:#222738;--border:#2a2f42;--border2:#353b52;--text:#e2e5f0;--text2:#7f849c;--text3:#565a6e;--green:#22c55e;--red:#ef4444;--yellow:#f59e0b;--cyan:#06b6d4;--cyan2:#0891b2;--purple:#a78bfa;--orange:#f97316;--pink:#ec4899;}
*{margin:0;padding:0;box-sizing:border-box;}html{font-size:14px;}
body{font-family:'Segoe UI',Tahoma,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;direction:rtl;overflow-x:hidden;}

.header{background:var(--bg2);border-bottom:1px solid var(--border);padding:10px 16px;display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;position:sticky;top:0;z-index:100;backdrop-filter:blur(12px);}
.logo{font-size:18px;font-weight:700;color:var(--cyan);white-space:nowrap;}.logo span{color:var(--text2);font-size:11px;font-weight:400;margin-right:6px;}
.controls{display:flex;align-items:center;gap:6px;flex-wrap:wrap;flex:1;justify-content:flex-end;}
select,button{background:var(--bg3);color:var(--text);border:1px solid var(--border);padding:7px 10px;border-radius:8px;font-size:13px;cursor:pointer;font-family:inherit;min-height:36px;transition:all .2s;}
select:focus,button:focus{outline:none;border-color:var(--cyan);}button:hover{background:var(--border);}
#selSymbol{max-width:160px;min-width:100px;}#selTF{width:68px;}
.btn-analyze{background:linear-gradient(135deg,var(--cyan),var(--cyan2));color:#000;font-weight:600;padding:7px 16px;white-space:nowrap;border:none;}
.btn-analyze:hover{opacity:.9;}.btn-analyze:disabled{opacity:.4;cursor:wait;}
.btn-multi{padding:7px 10px;white-space:nowrap;}
.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-left:4px;}
.status-ok{background:var(--green);box-shadow:0 0 6px var(--green);}.status-err{background:var(--red);}
.main{padding:12px;max-width:1440px;margin:0 auto;width:100%;}

/* BELL BUTTON */
.bell-wrap{position:relative;display:inline-flex;}
.bell-btn{background:none;border:none;font-size:20px;cursor:pointer;padding:4px;min-height:auto;position:relative;}
.bell-btn:hover{transform:scale(1.1);}
.bell-badge{position:absolute;top:-2px;left:-4px;background:var(--red);color:#fff;font-size:9px;font-weight:700;width:16px;height:16px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid var(--bg2);}

/* INLINE ALERT BUTTON (strategy/setup) */
.alert-trigger{background:none;border:none;font-size:14px;cursor:pointer;padding:2px 4px;min-height:auto;opacity:.5;transition:all .2s;flex-shrink:0;}
.alert-trigger:hover{opacity:1;transform:scale(1.15);}
.alert-trigger.has-alert{opacity:1;color:var(--yellow);}
/* MT5 INLINE BUTTON */
.mt5-trigger{background:none;border:none;font-size:14px;cursor:pointer;padding:2px 4px;min-height:auto;opacity:.5;transition:all .2s;flex-shrink:0;color:var(--purple);}
.mt5-trigger:hover{opacity:1;transform:scale(1.15);}
.mt5-trigger.linked{opacity:1;color:var(--purple);text-shadow:0 0 6px rgba(168,85,250,.4);}

/* NOTIFICATION PANEL */
.notif-panel{position:fixed;top:55px;left:16px;width:380px;max-height:70vh;background:var(--bg2);border:1px solid var(--border2);border-radius:14px;z-index:200;display:none;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,.5);}
.notif-panel.show{display:block;animation:fadeIn .2s;}
.notif-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border);background:var(--bg3);}
.notif-header h3{font-size:14px;color:var(--cyan);}
.notif-header button{font-size:11px;padding:4px 10px;min-height:auto;}
.notif-tabs{display:flex;border-bottom:1px solid var(--border);}
.notif-tab{flex:1;padding:8px;text-align:center;font-size:12px;cursor:pointer;color:var(--text2);transition:all .2s;border-bottom:2px solid transparent;}
.notif-tab.active{color:var(--cyan);border-bottom-color:var(--cyan);background:rgba(6,182,212,.05);}
.notif-list{overflow-y:auto;max-height:calc(70vh - 100px);padding:6px;}
.notif-item{padding:10px;border-radius:8px;margin-bottom:4px;cursor:pointer;transition:background .15s;border:1px solid transparent;}
.notif-item:hover{background:var(--bg3);}
.notif-item.unread{background:rgba(6,182,212,.05);border-color:var(--border);}
.notif-item .ni-head{display:flex;align-items:center;gap:6px;}
.notif-item .ni-icon{font-size:16px;}
.notif-item .ni-title{font-weight:600;font-size:12px;flex:1;}
.notif-item .ni-time{font-size:10px;color:var(--text3);}
.notif-item .ni-body{font-size:11px;color:var(--text2);margin-top:3px;line-height:1.5;}
.notif-empty{text-align:center;padding:30px;color:var(--text3);font-size:13px;}

/* ALERT MODAL */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);z-index:300;display:none;align-items:center;justify-content:center;padding:16px;}
.modal-overlay.show{display:flex;}
.modal-box{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:24px;width:100%;max-width:440px;}
.modal-box h2{color:var(--cyan);font-size:18px;margin-bottom:4px;text-align:center;}
.modal-box .modal-sub{color:var(--text2);font-size:12px;margin-bottom:14px;text-align:center;}
.modal-box input,.modal-box select{width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:10px 14px;border-radius:8px;font-size:13px;font-family:inherit;margin-bottom:8px;}
.modal-box input:focus,.modal-box select:focus{outline:none;border-color:var(--cyan);}
.modal-box input::placeholder{color:var(--text3);}
.modal-btn{width:100%;background:linear-gradient(135deg,var(--cyan),var(--cyan2));color:#000;font-weight:700;border:none;padding:12px;border-radius:10px;font-size:15px;cursor:pointer;margin-top:4px;}
.modal-btn:hover{opacity:.9;}.modal-btn:disabled{opacity:.5;cursor:wait;}
.modal-close{position:absolute;top:12px;left:12px;background:none;border:none;color:var(--text3);font-size:20px;cursor:pointer;min-height:auto;padding:4px;}
.modal-err{color:var(--red);font-size:12px;margin-top:6px;min-height:18px;text-align:center;}
.alert-type-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px;}
.alert-type-opt{padding:8px;border-radius:8px;background:var(--bg3);border:2px solid var(--border);cursor:pointer;text-align:center;transition:all .2s;font-size:11px;}
.alert-type-opt:hover{border-color:var(--cyan);}
.alert-type-opt.selected{border-color:var(--cyan);background:rgba(6,182,212,.1);}
.alert-type-opt .ato-icon{font-size:18px;display:block;margin-bottom:2px;}
.alert-type-opt .ato-name{font-weight:600;font-size:11px;}

/* TOAST */
.toast-wrap{position:fixed;top:60px;right:16px;z-index:400;display:flex;flex-direction:column;gap:6px;pointer-events:none;}
.toast{background:var(--bg2);border:1px solid var(--border2);border-radius:10px;padding:10px 14px;min-width:280px;max-width:380px;box-shadow:0 8px 30px rgba(0,0,0,.4);pointer-events:auto;animation:toastIn .3s;display:flex;align-items:flex-start;gap:8px;}
.toast.leaving{animation:toastOut .3s forwards;}
.toast .t-icon{font-size:20px;flex-shrink:0;}
.toast .t-body{flex:1;}
.toast .t-title{font-weight:700;font-size:12px;margin-bottom:2px;}
.toast .t-msg{font-size:11px;color:var(--text2);line-height:1.4;}
.toast .t-close{background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px;min-height:auto;padding:0;}
@keyframes toastIn{from{opacity:0;transform:translateX(30px);}to{opacity:1;transform:translateX(0);}}
@keyframes toastOut{to{opacity:0;transform:translateX(30px);}}
@keyframes fadeIn{from{opacity:0;transform:translateY(-4px);}to{opacity:1;transform:translateY(0);}}

/* ALL PREVIOUS STYLES */
.multi-bar{display:flex;gap:6px;margin-bottom:12px;overflow-x:auto;padding-bottom:6px;}
.multi-chip{flex-shrink:0;padding:6px 12px;border-radius:10px;background:var(--bg2);border:1px solid var(--border);cursor:pointer;text-align:center;min-width:90px;transition:all .2s;}
.multi-chip:hover{border-color:var(--cyan);}.multi-chip.active{border-color:var(--cyan);background:rgba(6,182,212,.08);}
.multi-chip .sym-name{font-weight:700;font-size:13px;}.multi-chip .sym-signal{font-size:18px;font-weight:800;margin:2px 0;}.multi-chip .sym-conf{font-size:11px;color:var(--text2);}
.signal-card{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:12px;text-align:center;}
.signal-badge{display:inline-block;font-size:32px;font-weight:800;padding:6px 28px;border-radius:12px;margin:6px 0;}
.signal-BUY{background:rgba(34,197,94,.12);color:var(--green);border:2px solid rgba(34,197,94,.4);}
.signal-SELL{background:rgba(239,68,68,.12);color:var(--red);border:2px solid rgba(239,68,68,.4);}
.signal-NEUTRAL{background:rgba(245,158,11,.12);color:var(--yellow);border:2px solid rgba(245,158,11,.4);}
.conf-bar{width:100%;max-width:350px;height:6px;background:var(--bg3);border-radius:3px;margin:8px auto;overflow:hidden;}
.conf-fill{height:100%;border-radius:3px;transition:width .5s;}
.signal-summary{color:var(--text2);font-size:13px;margin-top:4px;}.signal-meta{display:flex;justify-content:center;gap:14px;margin-top:8px;color:var(--text2);font-size:12px;flex-wrap:wrap;}
.vote-buy{color:var(--green);}.vote-sell{color:var(--red);}
.perf{display:flex;gap:12px;justify-content:center;margin-top:6px;font-size:11px;color:var(--text3);flex-wrap:wrap;}
.setup-master{background:linear-gradient(135deg,var(--bg2),var(--bg3));border:1px solid var(--border2);border-radius:14px;padding:16px;margin-bottom:12px;position:relative;overflow:hidden;}
.setup-master::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
.setup-master.setup-BUY::before{background:var(--green);}.setup-master.setup-SELL::before{background:var(--red);}.setup-master.setup-NONE::before{background:var(--border);}
.setup-title-bar{display:flex;align-items:center;gap:8px;margin-bottom:10px;flex-wrap:wrap;}
.setup-label{font-size:14px;font-weight:700;color:var(--cyan);}
.setup-quality{font-size:12px;padding:2px 8px;border-radius:6px;background:var(--bg);color:var(--yellow);}
.setup-levels{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;margin:8px 0;}
.setup-level{background:var(--bg);border-radius:8px;padding:8px;text-align:center;}
.setup-level .lbl{font-size:10px;color:var(--text3);margin-bottom:2px;}.setup-level .val{font-size:16px;font-weight:700;font-family:monospace;}
.setup-level.sl .val{color:var(--red);}.setup-level.entry .val{color:var(--cyan);}.setup-level.tp1 .val,.setup-level.tp2 .val{color:var(--green);}
.setup-rr{display:flex;gap:12px;justify-content:center;margin-top:6px;font-size:11px;color:var(--text2);flex-wrap:wrap;}
.setup-note{color:var(--text3);font-size:11px;margin-top:6px;text-align:center;line-height:1.6;}
.setup-nosetup{text-align:center;color:var(--text3);padding:14px;font-size:13px;}
.grid{display:grid;grid-template-columns:340px 1fr;gap:12px;}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:12px;overflow:hidden;min-width:0;}
.card-title{font-size:13px;color:var(--cyan);font-weight:600;margin-bottom:8px;border-bottom:1px solid var(--border);padding-bottom:6px;display:flex;align-items:center;gap:6px;}
.ctx-row{display:flex;justify-content:space-between;padding:3px 0;font-size:12px;}.ctx-label{color:var(--text2);}.ctx-val{font-weight:600;font-family:monospace;}
.price-big{font-size:24px;font-weight:700;font-family:monospace;}.price-spread{color:var(--text2);font-size:11px;}
.strats-panel{max-height:calc(100vh - 300px);overflow-y:auto;}
.cat-group{margin-bottom:6px;}.cat-header{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all .2s;user-select:none;}
.cat-header:hover{background:var(--bg4);}.cat-header.open{border-radius:8px 8px 0 0;border-bottom-color:transparent;background:var(--bg4);}
.cat-icon{font-size:16px;flex-shrink:0;}.cat-name{flex:1;font-weight:600;font-size:13px;}
.cat-badge{font-size:10px;padding:2px 8px;border-radius:10px;background:var(--bg);color:var(--text2);font-weight:600;}
.cat-arrow{font-size:10px;color:var(--text3);transition:transform .2s;}.cat-header.open .cat-arrow{transform:rotate(90deg);}
.cat-body{display:none;border:1px solid var(--border);border-top:none;border-radius:0 0 8px 8px;background:var(--bg2);padding:4px;}
.cat-header.open+.cat-body{display:block;}
.strat-item{display:flex;align-items:center;gap:6px;padding:5px 8px;border-radius:6px;font-size:12px;cursor:pointer;transition:background .15s;min-width:0;}
.strat-item:hover{background:var(--bg3);}.strat-item.open{background:var(--bg3);border-radius:6px 6px 0 0;}
.strat-sig{display:inline-block;width:46px;text-align:center;padding:2px 0;border-radius:4px;font-weight:700;font-size:10px;flex-shrink:0;}
.strat-sig-BUY{background:rgba(34,197,94,.18);color:var(--green);}.strat-sig-SELL{background:rgba(239,68,68,.18);color:var(--red);}.strat-sig-NEUTRAL{background:rgba(245,158,11,.12);color:var(--text3);}
.strat-conf{width:34px;text-align:left;font-family:monospace;color:var(--text2);font-size:11px;flex-shrink:0;}
.strat-name{flex:1;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;min-width:0;}
.strat-arrow{font-size:9px;color:var(--text3);flex-shrink:0;transition:transform .2s;margin-left:4px;}.strat-item.open .strat-arrow{transform:rotate(90deg);}
.strat-detail{display:none;background:var(--bg4);border:1px solid var(--border);border-top:none;border-radius:0 0 6px 6px;padding:10px 12px;margin-bottom:4px;font-size:11px;line-height:1.65;animation:fadeIn .2s;}
.strat-detail.show{display:block;}.strat-detail .reason-line{color:var(--text2);margin-bottom:6px;padding:4px 8px;background:var(--bg3);border-radius:4px;}
.strat-detail .mini-setup{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:6px 8px;margin-top:6px;}
.strat-detail .mini-setup .ms-row{display:flex;justify-content:space-between;font-size:11px;padding:1px 0;}
.strat-detail .mini-setup .ms-label{color:var(--text3);}.strat-detail .mini-setup .ms-val{font-family:monospace;font-weight:600;}
.strat-detail .ms-nosetup{color:var(--text3);font-size:11px;font-style:italic;margin-top:4px;}
.filter-tabs{display:flex;gap:4px;margin-bottom:8px;flex-wrap:wrap;}
.filter-tab{padding:3px 10px;border-radius:6px;font-size:11px;cursor:pointer;background:var(--bg3);border:1px solid var(--border);color:var(--text2);transition:all .2s;white-space:nowrap;}
.filter-tab:hover{border-color:var(--cyan);}.filter-tab.active{background:rgba(6,182,212,.12);border-color:var(--cyan);color:var(--cyan);font-weight:600;}
.loading{text-align:center;padding:30px;color:var(--text2);}.spinner{display:inline-block;width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--cyan);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
::-webkit-scrollbar{width:4px;height:4px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
@media(max-width:1024px){.grid{grid-template-columns:1fr 1fr;}}
@media(max-width:768px){html{font-size:13px;}.grid{grid-template-columns:1fr;}.header{padding:8px 12px;}.logo span{display:none;}.main{padding:8px;}.strats-panel{max-height:none;}.notif-panel{width:calc(100% - 32px);left:16px;right:16px;}}
@media(max-width:480px){html{font-size:12px;}.header{padding:6px 8px;flex-direction:column;align-items:stretch;}.logo{text-align:center;font-size:16px;}.controls{justify-content:center;gap:4px;}#selSymbol{flex:1;min-width:80px;max-width:none;}select,button{padding:6px 8px;min-height:34px;}.main{padding:6px;}.signal-badge{font-size:24px;padding:5px 18px;}.notif-panel{width:calc(100% - 16px);left:8px;right:8px;top:50px;max-height:80vh;}}

.clock{font-family:monospace;font-size:12px;color:var(--cyan);background:var(--bg3);padding:4px 10px;border-radius:6px;white-space:nowrap;direction:ltr;display:flex;align-items:center;gap:4px;}
.clock .clk-icon{font-size:14px;}
.auto-badge{font-size:9px;padding:2px 6px;border-radius:4px;background:rgba(34,197,94,.15);color:var(--green);font-weight:600;white-space:nowrap;cursor:pointer;}
.auto-badge.off{background:rgba(239,68,68,.15);color:var(--red);}
.strat-time{font-size:10px;color:var(--text3);margin-right:auto;font-family:monospace;direction:ltr;white-space:nowrap;}
.setup-time{font-size:10px;color:var(--text3);font-family:monospace;direction:ltr;text-align:center;margin-top:4px;}
.last-update{font-size:10px;color:var(--text3);text-align:center;margin-top:4px;}
.countdown-bar{height:2px;background:var(--bg3);border-radius:1px;margin-top:6px;overflow:hidden;}
.countdown-fill{height:100%;background:var(--cyan);transition:width 1s linear;border-radius:1px;}


.manage-btn{padding:3px 8px;border-radius:5px;background:rgba(244,114,182,.1);border:1px solid rgba(244,114,182,.3);color:#f472b6;font-size:9px;font-weight:700;cursor:pointer;transition:.2s;white-space:nowrap;}
.manage-btn:hover{background:rgba(244,114,182,.2);border-color:#f472b6;}
#riskManageModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:300;align-items:center;justify-content:center;}
#riskManageModal.show{display:flex;}
.rm-content{background:#12151c;border:1px solid #2a2f42;border-radius:14px;width:90%;max-width:600px;max-height:85vh;overflow-y:auto;padding:16px;}
.rm-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
.rm-head h3{font-size:15px;color:#f472b6;}
.rm-stat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:10px;}
.rm-stat{background:#1a1e2a;border:1px solid #2a2f42;border-radius:8px;padding:8px;text-align:center;}
.rm-stat .rv{font-size:16px;font-weight:700;}.rm-stat .rl{font-size:9px;color:#7f849c;margin-top:2px;}
.rm-milestone{display:flex;align-items:center;gap:6px;padding:4px 0;font-size:11px;border-bottom:1px solid rgba(255,255,255,.03);}
.rm-milestone .rm-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.rm-tips{margin-top:8px;}
.rm-tip{background:rgba(6,182,212,.04);border:1px solid rgba(6,182,212,.1);border-radius:6px;padding:6px 8px;margin-bottom:3px;font-size:10px;color:#06b6d4;}
.rm-warn{background:rgba(245,158,11,.05);border:1px solid rgba(245,158,11,.15);border-radius:6px;padding:6px 8px;margin-bottom:3px;font-size:10px;color:#f59e0b;}
.rm-actions{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap;}

/* Risk Manager Deep Integration */
.rm-floating{position:fixed;bottom:0;left:0;right:0;z-index:200;background:#0d1017;border-top:2px solid #06b6d4;transform:translateY(100%);transition:transform .3s;max-height:45vh;overflow-y:auto;}
.rm-floating.show{transform:translateY(0);}
.rm-float-head{display:flex;align-items:center;justify-content:space-between;padding:8px 16px;background:#12151c;border-bottom:1px solid #2a2f42;cursor:pointer;}
.rm-float-head h4{font-size:13px;color:#06b6d4;font-weight:700;}
.rm-float-body{padding:10px 16px;}
.rm-float-trades{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:8px;}
.rm-ft{background:#1a1e2a;border:1px solid #2a2f42;border-radius:8px;padding:8px 10px;transition:.2s;}
.rm-ft:hover{border-color:#06b6d4;}
.rm-ft-head{display:flex;align-items:center;gap:6px;margin-bottom:4px;}
.rm-ft-badge{padding:1px 6px;border-radius:3px;font-size:9px;font-weight:700;}
.rm-ft-badge.buy{background:rgba(34,197,94,.12);color:#22c55e;}
.rm-ft-badge.sell{background:rgba(239,68,68,.12);color:#ef4444;}
.rm-ft-sym{font-weight:600;font-size:12px;color:#e2e5f0;}
.rm-ft-pnl{margin-right:auto;font-weight:800;font-size:13px;}
.rm-ft-reco{font-size:10px;padding:4px 8px;border-radius:4px;margin-top:4px;line-height:1.3;}
.rm-ft-reco.critical{background:rgba(239,68,68,.06);color:#ef4444;border:1px solid rgba(239,68,68,.15);}
.rm-ft-reco.high{background:rgba(245,158,11,.06);color:#f59e0b;border:1px solid rgba(245,158,11,.15);}
.rm-ft-reco.low{background:rgba(6,182,212,.04);color:#06b6d4;border:1px solid rgba(6,182,212,.1);}
.rm-ft-bar{height:4px;background:#2a2f42;border-radius:2px;margin:4px 0;}
.rm-ft-fill{height:100%;border-radius:2px;transition:width .5s;}
.risk-score-widget{display:none !important;}
.rs-circle{width:50px;height:50px;border-radius:50%;border:3px solid;display:flex;align-items:center;justify-content:center;margin:0 auto 4px;font-size:18px;font-weight:900;}
.rs-label{font-size:9px;color:#7f849c;}
.alert-popup{position:fixed;top:12px;right:12px;z-index:500;display:flex;flex-direction:column;gap:4px;}
.alert-item{background:#12151c;border:1px solid;border-radius:8px;padding:8px 12px;animation:slideIn .3s;max-width:350px;font-size:11px;cursor:pointer;}
.alert-item.critical{border-color:#ef4444;background:rgba(239,68,68,.05);}
.alert-item.high{border-color:#f59e0b;background:rgba(245,158,11,.04);}
.alert-item .ai-msg{font-weight:600;}.alert-item .ai-action{font-size:10px;color:#7f849c;margin-top:2px;}
@keyframes slideIn{from{transform:translateX(100%);opacity:0;}to{transform:translateX(0);opacity:1;}}
.manage-btn-v2{display:inline-flex;align-items:center;gap:3px;padding:3px 8px;border-radius:5px;background:linear-gradient(135deg,rgba(244,114,182,.08),rgba(167,139,250,.08));border:1px solid rgba(244,114,182,.25);color:#f472b6;font-size:9px;font-weight:700;cursor:pointer;transition:.2s;white-space:nowrap;}
.manage-btn-v2:hover{background:linear-gradient(135deg,rgba(244,114,182,.15),rgba(167,139,250,.15));border-color:#f472b6;transform:scale(1.02);}

/* â•â•â• Fixed Risk Manage Modal â•â•â• */
#riskManageModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.75);z-index:300;align-items:flex-start;justify-content:center;padding-top:40px;overflow-y:auto;}
#riskManageModal.show{display:flex;}
.rm-content{background:#0d1017;border:1px solid #2a2f42;border-radius:14px;width:95%;max-width:750px;max-height:85vh;overflow-y:auto;padding:0;margin-bottom:40px;}
.rm-top{background:#12151c;padding:12px 16px;border-bottom:1px solid #2a2f42;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:2;}
.rm-top h3{font-size:14px;color:#f472b6;font-weight:700;}
.rm-top .rm-close{background:transparent;border:1px solid #2a2f42;color:#7f849c;width:28px;height:28px;border-radius:6px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;}
.rm-top .rm-close:hover{border-color:#ef4444;color:#ef4444;}
.rm-body{padding:14px 16px;}
.rm-info-bar{display:flex;align-items:center;gap:8px;padding:8px 12px;background:#1a1e2a;border:1px solid #2a2f42;border-radius:8px;margin-bottom:10px;flex-wrap:wrap;}
.rm-info-bar .ri-badge{padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;}
.rm-info-bar .ri-badge.buy{background:rgba(34,197,94,.12);color:#22c55e;}
.rm-info-bar .ri-badge.sell{background:rgba(239,68,68,.12);color:#ef4444;}
.rm-form{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin-bottom:10px;}
.rm-form .rmf{display:flex;flex-direction:column;}
.rm-form .rmf label{font-size:9px;color:#7f849c;margin-bottom:2px;}
.rm-form .rmf input{padding:6px 8px;border-radius:6px;border:1px solid #2a2f42;background:#1a1e2a;color:#e2e5f0;font-size:12px;font-family:inherit;width:100%;}
.rm-form .rmf input:focus{border-color:#06b6d4;outline:none;}
.rm-calc-btn{width:100%;padding:8px;border-radius:8px;background:linear-gradient(135deg,#f472b6,#a78bfa);color:#000;font-weight:700;font-size:13px;border:none;cursor:pointer;margin-bottom:12px;transition:.2s;}
.rm-calc-btn:hover{opacity:.9;transform:scale(1.01);}
.rm-results{min-height:50px;}
.rm-stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:10px;}
.rm-stat{background:#1a1e2a;border:1px solid #2a2f42;border-radius:8px;padding:8px;text-align:center;}
.rm-stat .rv{font-size:16px;font-weight:800;}.rm-stat .rl{font-size:8px;color:#7f849c;margin-top:2px;line-height:1.3;}
.rm-section{margin-bottom:10px;}
.rm-section-title{font-size:11px;color:#06b6d4;font-weight:700;margin-bottom:4px;display:flex;align-items:center;gap:4px;}
.rm-milestone{display:flex;align-items:flex-start;gap:8px;padding:5px 0;border-bottom:1px solid rgba(255,255,255,.03);font-size:11px;}
.rm-milestone .rm-dot{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0;background:#1a1e2a;border:1px solid #2a2f42;}
.rm-milestone .rm-ms-stage{font-weight:700;}.rm-milestone .rm-ms-price{color:#06b6d4;font-size:10px;}.rm-milestone .rm-ms-action{color:#7f849c;font-size:10px;}.rm-milestone .rm-ms-detail{color:#565a6e;font-size:9px;line-height:1.3;margin-top:1px;}
.rm-partial{display:flex;align-items:center;gap:6px;padding:4px 8px;background:#1a1e2a;border:1px solid #2a2f42;border-radius:6px;margin-bottom:3px;font-size:10px;}
.rm-partial .rp-level{font-weight:700;color:#22c55e;min-width:35px;}
.rm-partial .rp-pct{background:rgba(34,197,94,.1);color:#22c55e;padding:1px 5px;border-radius:3px;font-weight:700;font-size:9px;}
.rm-trailing{background:#1a1e2a;border:1px solid #2a2f42;border-radius:8px;padding:8px;margin-bottom:3px;}
.rm-trailing .rt-name{font-size:11px;font-weight:700;color:#a78bfa;}.rm-trailing .rt-val{font-size:10px;color:#06b6d4;margin-top:2px;}.rm-trailing .rt-desc{font-size:9px;color:#7f849c;margin-top:2px;line-height:1.3;}
.rm-warning{background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.15);border-radius:6px;padding:5px 8px;margin-bottom:3px;font-size:10px;color:#f59e0b;}
.rm-tip{background:rgba(6,182,212,.04);border:1px solid rgba(6,182,212,.1);border-radius:6px;padding:5px 8px;margin-bottom:3px;font-size:10px;color:#06b6d4;line-height:1.4;}
.rm-swap{font-size:10px;color:#7f849c;padding:4px 8px;background:#1a1e2a;border-radius:6px;}
@media(max-width:700px){.rm-form{grid-template-columns:1fr 1fr;}.rm-stat-grid{grid-template-columns:repeat(2,1fr);}}


/* Track Record Badges */
.track-badge{display:inline-flex;align-items:center;gap:3px;padding:2px 6px;border-radius:4px;font-size:8px;font-weight:700;cursor:pointer;transition:.2s;white-space:nowrap;}
.track-badge.good{background:rgba(34,197,94,.08);border:1px solid rgba(34,197,94,.2);color:#22c55e;}
.track-badge.mid{background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.15);color:#f59e0b;}
.track-badge.bad{background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.15);color:#ef4444;}
.track-badge.none{background:rgba(127,132,156,.05);border:1px solid rgba(127,132,156,.1);color:#7f849c;}
.track-badge:hover{transform:scale(1.05);}
.track-badge .tb-dots{display:flex;gap:1px;}
.track-badge .tb-dot{width:5px;height:5px;border-radius:50%;display:inline-block;}
.tb-tooltip{position:fixed;background:#12151c;border:1px solid #2a2f42;border-radius:8px;padding:8px 10px;z-index:400;font-size:10px;color:#e2e5f0;max-width:250px;pointer-events:none;display:none;box-shadow:0 4px 16px rgba(0,0,0,.4);}
.tb-tooltip .tt-row{display:flex;justify-content:space-between;gap:10px;padding:1px 0;}
.tb-tooltip .tt-label{color:#7f849c;}.tb-tooltip .tt-val{font-weight:700;}

/* Notification Toast */
.notif-toast-container{position:fixed;top:10px;left:10px;z-index:500;display:flex;flex-direction:column;gap:6px;max-width:360px;pointer-events:none;}
.notif-toast{background:var(--bg2,#1e293b);border:1px solid rgba(245,158,11,.25);border-radius:10px;padding:10px 14px;display:flex;gap:8px;align-items:flex-start;animation:toastIn .3s ease;pointer-events:auto;box-shadow:0 4px 20px rgba(0,0,0,.4);max-width:360px;}
.notif-toast.closing{animation:toastOut .3s ease forwards;}
@keyframes toastIn{from{opacity:0;transform:translateX(-30px);}to{opacity:1;transform:translateX(0);}}
@keyframes toastOut{to{opacity:0;transform:translateX(-30px);}}
.nt-icon{font-size:18px;flex-shrink:0;}
.nt-body{flex:1;min-width:0;}
.nt-title{font-size:11px;font-weight:700;color:#f59e0b;}
.nt-detail{font-size:9px;color:var(--text2,#94a3b8);margin-top:2px;line-height:1.3;white-space:pre-line;}
.nt-close{background:none;border:none;color:var(--text3,#64748b);cursor:pointer;font-size:12px;padding:0 2px;flex-shrink:0;}
.dash-bell{position:relative;cursor:pointer;font-size:18px;padding:4px 6px;margin-left:8px;}
.dash-bell .db-count{position:absolute;top:-2px;right:-4px;background:#ef4444;color:#fff;font-size:7px;font-weight:800;padding:1px 3px;border-radius:6px;min-width:12px;text-align:center;}


/* â•â•â• UNIVERSAL NAV â•â•â• */
.wnav{position:sticky;top:0;z-index:1000;background:rgba(8,11,18,.92);backdrop-filter:blur(20px) saturate(1.5);-webkit-backdrop-filter:blur(20px) saturate(1.5);border-bottom:1px solid rgba(30,42,69,.6);padding:0 20px;height:54px;display:flex;align-items:center;justify-content:space-between;}
.wnav-logo{display:flex;align-items:center;gap:9px;text-decoration:none;flex-shrink:0;}
.wnav-logo-box{width:32px;height:32px;background:linear-gradient(135deg,#00d4ff,#a855f7);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:900;color:#fff;box-shadow:0 0 16px rgba(0,212,255,.25);}
.wnav-logo-txt{font-size:17px;font-weight:800;background:linear-gradient(135deg,#00d4ff,#a855f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:-.3px;}
.wnav-links{display:flex;align-items:center;gap:1px;overflow-x:auto;scrollbar-width:none;-ms-overflow-style:none;}
.wnav-links::-webkit-scrollbar{display:none;}
.wnav-links a{color:#8892a8;padding:6px 10px;border-radius:7px;font-size:12.5px;font-weight:500;white-space:nowrap;transition:all .2s;text-decoration:none;}
.wnav-links a:hover{background:rgba(255,255,255,.04);color:#e8ecf4;}
.wnav-links a.wn-active{color:#00d4ff;background:rgba(0,212,255,.08);font-weight:600;}
.wnav-cta{background:linear-gradient(135deg,#00d4ff,#a855f7) !important;color:#000 !important;font-weight:700 !important;padding:6px 14px !important;border-radius:7px !important;font-size:12px !important;}
.wnav-back{display:flex;align-items:center;gap:5px;color:#8892a8;font-size:12px;padding:5px 10px;border-radius:7px;cursor:pointer;background:rgba(255,255,255,.03);border:1px solid rgba(30,42,69,.5);transition:all .2s;text-decoration:none;flex-shrink:0;margin-left:6px;}
.wnav-back:hover{color:#00d4ff;border-color:rgba(0,212,255,.3);background:rgba(0,212,255,.04);}
.wnav-ham{display:none;background:none;border:none;color:#e8ecf4;font-size:22px;cursor:pointer;padding:4px;}
.wnav-mob-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);z-index:999;}
.wnav-mob-overlay.open{display:block;}
.wnav-mob{position:fixed;top:0;right:0;width:270px;height:100vh;background:#0f1320;border-left:1px solid #1e2a45;z-index:1001;transform:translateX(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);padding:64px 14px 20px;overflow-y:auto;display:flex;flex-direction:column;gap:2px;}
.wnav-mob-overlay.open .wnav-mob{transform:translateX(0);}
.wnav-mob a{display:flex;align-items:center;gap:9px;color:#8892a8;padding:11px 14px;border-radius:9px;font-size:13.5px;text-decoration:none;transition:all .15s;}
.wnav-mob a:hover{background:rgba(255,255,255,.04);color:#e8ecf4;}
.wnav-mob a.wn-active{background:rgba(0,212,255,.08);color:#00d4ff;font-weight:600;}
.wnav-mob-close{position:absolute;top:14px;left:14px;background:#161b2e;border:1px solid #1e2a45;color:#8892a8;width:32px;height:32px;border-radius:8px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
@media(max-width:900px){.wnav-links{display:none;}.wnav-ham{display:block;}.wnav-back{font-size:11px;padding:4px 8px;}}

/* â•â•â• UNIVERSAL FOOTER â•â•â• */
.wfooter{background:#0f1320;border-top:1px solid #1e2a45;padding:32px 20px 16px;margin-top:24px;}
.wfooter-grid{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:32px;margin-bottom:28px;}
.wfooter-brand p{font-size:12px;color:#5a6480;margin-top:8px;line-height:1.8;}
.wfooter-col h4{font-size:12px;font-weight:700;color:#e8ecf4;margin-bottom:12px;}
.wfooter-col a{display:block;color:#5a6480;font-size:12px;padding:3px 0;text-decoration:none;transition:color .2s;}
.wfooter-col a:hover{color:#00d4ff;}
.wfooter-bottom{max-width:1100px;margin:0 auto;border-top:1px solid #1e2a45;padding-top:14px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;}
.wfooter-bottom p{font-size:11px;color:#5a6480;}
.wfooter-bottom a{color:#00d4ff;text-decoration:none;font-size:11px;}
@media(max-width:768px){.wfooter-grid{grid-template-columns:1fr 1fr;gap:20px;}}
@media(max-width:480px){.wfooter-grid{grid-template-columns:1fr;}}


/* â•â•â• CHART PANEL â•â•â• */
.wchart-panel{background:#0f1320;border:1px solid #1e2a45;border-radius:14px;margin:10px 0 16px;overflow:hidden;position:relative;}
.wchart-header{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;border-bottom:1px solid #1e2a45;background:rgba(15,19,32,0.8);flex-wrap:wrap;gap:6px;}
.wchart-title{display:flex;align-items:center;gap:8px;font-size:13px;font-weight:700;color:#e8ecf4;}
.wchart-title .sym{color:#00d4ff;font-size:15px;}
.wchart-title .tf-badge{background:rgba(0,212,255,0.1);color:#00d4ff;padding:2px 8px;border-radius:5px;font-size:11px;font-weight:600;}
.wchart-title .trade-badge{background:rgba(168,85,250,0.15);color:#a855f7;padding:2px 8px;border-radius:5px;font-size:10px;margin-right:6px;}
.wchart-controls{display:flex;align-items:center;gap:4px;}
.wchart-controls button{background:#1a1e2a;border:1px solid #2a2f42;color:#8892a8;padding:4px 10px;border-radius:6px;font-size:11px;cursor:pointer;transition:all .2s;font-family:inherit;}
.wchart-controls button:hover{border-color:#00d4ff;color:#00d4ff;}
.wchart-controls button.active{background:rgba(0,212,255,0.12);color:#00d4ff;border-color:rgba(0,212,255,0.3);font-weight:600;}
.wchart-body{height:350px;width:100%;position:relative;}
.wchart-legend{position:absolute;top:10px;right:14px;z-index:5;display:flex;gap:10px;font-size:10px;color:#8892a8;}
.wchart-legend span{display:flex;align-items:center;gap:3px;}
.wchart-legend .dot{width:8px;height:8px;border-radius:50%;}
@media(max-width:768px){.wchart-body{height:250px;}.wchart-header{padding:8px 10px;}}


/* â•â•â• SETUP INFO PANEL â•â•â• */
.wsetup-card{background:#12151c;border:1px solid #1e2a45;border-radius:10px;padding:10px 14px;margin:0;}
.wsetup-card.buy{border-right:3px solid #22c55e;}
.wsetup-card.sell{border-right:3px solid #ef4444;}
.wsetup-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.wsetup-strat{font-size:12px;font-weight:700;color:#e8ecf4;}
.wsetup-dir{font-size:12px;font-weight:700;padding:2px 10px;border-radius:5px;}
.wsetup-card.buy .wsetup-dir{background:rgba(34,197,94,0.15);color:#22c55e;}
.wsetup-card.sell .wsetup-dir{background:rgba(239,68,68,0.15);color:#ef4444;}
.wsetup-prices{display:flex;flex-wrap:wrap;gap:8px;}
.wsetup-prices > div{display:flex;flex-direction:column;align-items:center;min-width:55px;}
.wsetup-prices .label{font-size:9px;color:#5a6480;margin-bottom:2px;}
.wsetup-prices .val{font-size:12px;font-weight:700;font-family:'JetBrains Mono',monospace;}
.wsetup-prices .val.entry{color:#00d4ff;}
.wsetup-prices .val.sl{color:#ef4444;}
.wsetup-prices .val.tp{color:#22c55e;}
.wsetup-prices .val.rr{color:#a855f7;}
.wsetup-prices .val.conf{color:#f59e0b;}
.wsetup-prices .val.wr{color:#06b6d4;}
.wchart-ma-legend{display:flex;gap:12px;font-size:10px;color:#8892a8;padding:4px 16px;background:#0a0c10;border-top:1px solid #1e2a45;}
.wchart-ma-legend span{display:flex;align-items:center;gap:3px;cursor:pointer;transition:opacity .2s;}
.wchart-ma-legend span:hover{opacity:0.7;}
.wchart-ma-legend .line{width:16px;height:2px;border-radius:1px;}



.wchart-panel{position:relative !important;max-height:460px;overflow:hidden;}
.wchart-body{height:350px !important;min-height:200px;max-height:350px;}
.wchart-header{position:relative !important;padding:8px 12px !important;}
.wchart-controls{flex-wrap:wrap;gap:3px !important;}
.wchart-controls button{padding:3px 7px !important;font-size:10px !important;}
@media(max-width:768px){
  .wchart-body{height:250px !important;max-height:250px !important;}
  .wchart-panel{max-height:370px;}
  .wchart-header{flex-direction:column;align-items:flex-start;gap:6px !important;}
  .wchart-controls{width:100%;justify-content:flex-start;}
  .wchart-controls button{padding:4px 6px !important;font-size:9px !important;}
  .wchart-title{font-size:12px !important;}
  .wchart-legend{font-size:8px !important;gap:6px !important;}
  .wchart-ma-legend{font-size:9px !important;flex-wrap:wrap;gap:6px !important;padding:3px 10px !important;}
  .wsetup-prices{gap:4px !important;}
  .wsetup-prices .val{font-size:10px !important;}
}
@media(max-width:480px){
  .wchart-body{height:200px !important;max-height:200px !important;}
  .wchart-panel{max-height:320px;}
}


/* â•â•â• CHART v3 â€” compact, hidden default â•â•â• */
.wchart-wrapper{margin:12px 0;animation:wchartSlide .3s ease-out;}
@keyframes wchartSlide{from{opacity:0;transform:translateY(-10px);}to{opacity:1;transform:translateY(0);}}
.wchart-panel{background:#0f1320;border:1px solid #1e2a45;border-radius:12px;overflow:hidden;}
.wchart-header{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:1px solid #1e2a45;background:rgba(15,19,32,.8);flex-wrap:wrap;gap:4px;}
.wchart-title{display:flex;align-items:center;gap:6px;font-size:12px;font-weight:700;color:#e8ecf4;}
.wchart-title .sym{color:#00d4ff;font-size:14px;}
.wchart-title .tf-badge{background:rgba(0,212,255,.1);color:#00d4ff;padding:1px 6px;border-radius:4px;font-size:10px;font-weight:600;}
.wchart-title .trade-badge{background:rgba(168,85,250,.15);color:#a855f7;padding:1px 6px;border-radius:4px;font-size:9px;}
.wchart-controls{display:flex;align-items:center;gap:2px;flex-wrap:wrap;}
.wchart-controls button{background:#1a1e2a;border:1px solid #2a2f42;color:#8892a8;padding:3px 7px;border-radius:5px;font-size:10px;cursor:pointer;transition:all .15s;font-family:inherit;line-height:1.2;}
.wchart-controls button:hover{border-color:#00d4ff;color:#00d4ff;}
.wchart-controls button.active{background:rgba(0,212,255,.12);color:#00d4ff;border-color:rgba(0,212,255,.3);font-weight:600;}
.wchart-body{height:340px;width:100%;position:relative;}
.wchart-legend{position:absolute;top:8px;right:10px;z-index:5;display:flex;gap:8px;font-size:9px;color:#8892a8;}
.wchart-legend span{display:flex;align-items:center;gap:2px;}
.wchart-legend .dot{width:6px;height:6px;border-radius:50%;}
.wsetup-card{background:#12151c;border:1px solid #1e2a45;border-radius:8px;padding:8px 12px;}
.wsetup-card.buy{border-right:3px solid #22c55e;}
.wsetup-card.sell{border-right:3px solid #ef4444;}
.wsetup-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
.wsetup-strat{font-size:11px;font-weight:700;color:#e8ecf4;}
.wsetup-dir{font-size:11px;font-weight:700;padding:1px 8px;border-radius:4px;}
.wsetup-card.buy .wsetup-dir{background:rgba(34,197,94,.15);color:#22c55e;}
.wsetup-card.sell .wsetup-dir{background:rgba(239,68,68,.15);color:#ef4444;}
.wsetup-prices{display:flex;flex-wrap:wrap;gap:6px;}
.wsetup-prices>div{display:flex;flex-direction:column;align-items:center;min-width:48px;}
.wsetup-prices .label{font-size:8px;color:#5a6480;margin-bottom:1px;}
.wsetup-prices .val{font-size:11px;font-weight:700;font-family:'JetBrains Mono',monospace;}
.wsetup-prices .val.entry{color:#00d4ff;}.wsetup-prices .val.sl{color:#ef4444;}.wsetup-prices .val.tp{color:#22c55e;}
.wsetup-prices .val.rr{color:#a855f7;}.wsetup-prices .val.conf{color:#f59e0b;}.wsetup-prices .val.wr{color:#06b6d4;}
@media(max-width:768px){
  .wchart-body{height:240px !important;}
  .wchart-header{padding:6px 8px;}
  .wchart-controls button{padding:2px 5px;font-size:9px;}
  .wchart-title{font-size:11px;}
  .wchart-legend{font-size:8px;gap:4px;}
}
@media(max-width:480px){
  .wchart-body{height:190px !important;}
  .wsetup-prices .val{font-size:10px;}
}

</style>
</head>
<body>
<!-- â•â•â• UNIVERSAL TOP NAV â•â•â• -->
<nav class="wnav" id="wTopNav">
  <div style="display:flex;align-items:center;gap:8px;">
    <a href="/" class="wnav-logo">
      <div class="wnav-logo-box">W</div>
      <span class="wnav-logo-txt">Whilber-AI</span>
    </a>
    <a href="javascript:history.back()" class="wnav-back" title="Ø¨Ø§Ø²Ú¯Ø´Øª">â†’ Ø¨Ø±Ú¯Ø´Øª</a>
  </div>
  <div class="wnav-links">
    <a href="/">Ø®Ø§Ù†Ù‡</a>
    <a href="/dashboard" class="wn-active">ØªØ­Ù„ÛŒÙ„ Ø¨Ø§Ø²Ø§Ø±</a>
    <a href="/track-record">Ø³ÙˆØ§Ø¨Ù‚</a>
    <a href="/builder">Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒâ€ŒØ³Ø§Ø²</a>
    <a href="/risk-manager">Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÛŒØ³Ú©</a>
    <a href="/journal">Ú˜ÙˆØ±Ù†Ø§Ù„</a>
    <a href="/performance">Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø²Ù†Ø¯Ù‡</a>
    <a href="/alerts">Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§</a>
    <a href="/guide">Ø±Ø§Ù‡Ù†Ù…Ø§</a>
    <a href="/services">Ø®Ø¯Ù…Ø§Øª</a>
    <a href="/about">Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§</a>
    <a href="/contact">ØªÙ…Ø§Ø³</a>
    <a href="/robots">Ø±Ø¨Ø§Øªâ€ŒÙ‡Ø§</a>
    <a href="/pricing">ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§</a>
    <a href="/login">ÙˆØ±ÙˆØ¯</a>
    <a href="/register">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</a>
    <a href="/dashboard" class="wnav-cta">ğŸš€ ØªØ­Ù„ÛŒÙ„</a>
  </div>
  <button class="wnav-ham" onclick="document.getElementById('wMobOverlay').classList.add('open')">â˜°</button>
</nav>
<div class="wnav-mob-overlay" id="wMobOverlay" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="wnav-mob">
    <button class="wnav-mob-close" onclick="document.getElementById('wMobOverlay').classList.remove('open')">âœ•</button>
    <a href="javascript:history.back()" style="color:#00d4ff;border:1px solid rgba(0,212,255,.2);margin-bottom:8px;">â†’ Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ù‚Ø¨Ù„</a>
    <a href="/">ğŸ  Ø®Ø§Ù†Ù‡</a>
    <a href="/dashboard" class="wn-active">ğŸ“Š ØªØ­Ù„ÛŒÙ„ Ø¨Ø§Ø²Ø§Ø±</a>
    <a href="/track-record">ğŸ“œ Ø³ÙˆØ§Ø¨Ù‚</a>
    <a href="/builder">ğŸ”§ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒâ€ŒØ³Ø§Ø²</a>
    <a href="/risk-manager">ğŸ›¡ï¸ Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÛŒØ³Ú©</a>
    <a href="/journal">ğŸ“’ Ú˜ÙˆØ±Ù†Ø§Ù„</a>
    <a href="/performance">&#x1F4C8; Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø²Ù†Ø¯Ù‡</a>
    <a href="/alerts">ğŸ”” Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§</a>
    <a href="/robots">&#x1F916; Ø±Ø¨Ø§Øªâ€ŒÙ‡Ø§</a>
    <a href="/guide">ğŸ“– Ø±Ø§Ù‡Ù†Ù…Ø§</a>
    <a href="/services">â­ Ø®Ø¯Ù…Ø§Øª</a>
    <a href="/about">ğŸ‘¤ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§</a>
    <a href="/contact">ğŸ“ ØªÙ…Ø§Ø³</a>
    <a href="/pricing">ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§</a>
    <a href="/admin">âš™ï¸ Ø§Ø¯Ù…ÛŒÙ†</a>
    <a href="/login">&#x1F511; ÙˆØ±ÙˆØ¯</a>
    <a href="/register">&#x1F4DD; Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</a>
  </div>
</div>


<style>.alert-bell{position:fixed;top:12px;left:12px;z-index:9999;background:rgba(6,182,212,.15);border:1px solid #06b6d4;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.2s;text-decoration:none;font-size:18px;}.alert-bell:hover{background:rgba(6,182,212,.3);transform:scale(1.1);}
.upsell-banner{display:none;background:linear-gradient(135deg,rgba(0,212,255,.08),rgba(168,85,247,.08));border:1px solid rgba(0,212,255,.25);border-radius:12px;padding:14px 20px;margin:12px auto;max-width:700px;text-align:center;animation:fadeInUp .3s ease;}
.upsell-banner .upsell-text{font-size:13px;color:#e8ecf4;margin-bottom:8px;line-height:1.7;}
.upsell-banner .upsell-btn{display:inline-block;background:linear-gradient(135deg,#00d4ff,#a855f7);color:#000;font-weight:800;padding:8px 24px;border-radius:8px;font-size:13px;transition:all .2s;}
.upsell-banner .upsell-btn:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,212,255,.3);}
.truncation-notice{display:none;background:rgba(255,190,46,.06);border:1px solid rgba(255,190,46,.2);border-radius:8px;padding:8px 14px;margin:8px auto;max-width:700px;text-align:center;font-size:12px;color:#ffbe2e;}
@keyframes fadeInUp{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}</style>
<div id="upsellBanner" class="upsell-banner"><div class="upsell-text" id="upsellText"></div><a href="/pricing" class="upsell-btn">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ù„Ù†â€ŒÙ‡Ø§</a></div>
<div id="truncationNotice" class="truncation-notice"></div>
<a href="/alerts-settings" class="alert-bell" title="ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¢Ù„Ø±Øª">ğŸ””</a>


<!-- duplicate nav removed -->


<!-- REGISTRATION MODAL -->
<div class="modal-overlay" id="regModal">
  <div class="modal-box" style="position:relative;">
    <h2>ğŸ§  Whilber-AI</h2>
    <p class="modal-sub">Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§Ù…Ú©Ø§Ù†Ø§Øª Ø³Ø§ÛŒØª Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª</p>
    <input type="text" id="regName" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ *" autocomplete="name">
    <input type="email" id="regEmail" placeholder="Ø§ÛŒÙ…ÛŒÙ„ *" autocomplete="email" dir="ltr">
    <input type="tel" id="regPhone" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" dir="ltr">
    <button class="modal-btn" id="regBtn" onclick="doRegister()">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ùˆ ÙˆØ±ÙˆØ¯</button>
    <div class="modal-err" id="regErr"></div>
  </div>
</div>

<!-- ALERT CREATION MODAL -->
<div class="modal-overlay" id="alertModal">
  <div class="modal-box" style="position:relative;">
    <button class="modal-close" onclick="hideAlertModal()">âœ•</button>
    <h2>ğŸ”” ØªÙ†Ø¸ÛŒÙ… Ù‡Ø´Ø¯Ø§Ø±</h2>
    <div class="modal-sub" id="alertModalSub"></div>
    <div class="alert-type-grid" id="alertTypeGrid"></div>
    <input type="email" id="alertEmail" placeholder="Ø§ÛŒÙ…ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù‡Ø´Ø¯Ø§Ø±" dir="ltr">
    <button class="modal-btn" id="alertBtn" onclick="submitAlert()">ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù‡Ø´Ø¯Ø§Ø±</button>
    <div class="modal-err" id="alertErr"></div>
  </div>
</div>

<!-- MT5 CONNECTION MODAL -->
<div class="modal-overlay" id="mt5ModalDash" onclick="if(event.target===this)closeMT5Dash();">
  <div class="modal-box" style="position:relative;max-width:480px;">
    <button class="modal-close" onclick="closeMT5Dash()">âœ•</button>
    <h2 style="color:var(--purple);">âš¡ Ø§ØªØµØ§Ù„ Ø¨Ù‡ MetaTrader</h2>
    <div class="modal-sub" id="mt5DashSub">â€”</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:10px;">
      <div><span style="font-size:10px;color:var(--text3);">Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ</span><div style="font-weight:700;font-size:12px;" id="mt5DashStrat">â€”</div></div>
      <div><span style="font-size:10px;color:var(--text3);">Ù†Ù…Ø§Ø¯</span><div style="font-weight:700;font-size:12px;" id="mt5DashSym">â€”</div></div>
    </div>
    <div id="mt5DashAccSelect" style="margin-bottom:10px;display:none;">
      <label style="font-size:10px;color:var(--text2);margin-bottom:4px;display:block;">Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯:</label>
      <select id="mt5DashExistingAcc" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg3);color:var(--text);font-size:11px;font-family:inherit;">
        <option value="">+ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÛŒØ¯</option>
      </select>
    </div>
    <div id="mt5DashNewForm">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px;">
        <div><label style="font-size:10px;color:var(--text2);">ğŸ”¢ Ø´Ù…Ø§Ø±Ù‡ Ø­Ø³Ø§Ø¨</label><input type="text" id="mt5DashAccNum" placeholder="123456"></div>
        <div><label style="font-size:10px;color:var(--text2);">ğŸ”‘ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label><input type="password" id="mt5DashPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢"></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px;">
        <div><label style="font-size:10px;color:var(--text2);">ğŸŒ Ø³Ø±ÙˆØ±</label><input type="text" id="mt5DashServer" placeholder="BrokerName-Live"></div>
        <div><label style="font-size:10px;color:var(--text2);">ğŸ“ Ù„Ø§Øª Ø³Ø§ÛŒØ²</label><input type="number" id="mt5DashLot" value="0.01" step="0.01" min="0.01" max="10"></div>
      </div>
    </div>
    <div style="font-size:10px;color:var(--text3);margin:8px 0;padding:6px;background:var(--bg3);border-radius:6px;line-height:1.5;">âš ï¸ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø³Ø§Ø¨ Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒ Ùˆ Ø±ÙˆÛŒ Ø³Ø±ÙˆØ± Ø´Ù…Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯. ÙÙ‚Ø· Ø³ÛŒÚ¯Ù†Ø§Ù„â€Œ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
    <button class="modal-btn" style="background:linear-gradient(135deg,var(--purple),#7c3aed);" onclick="saveMT5Dash()">âš¡ Ø§ØªØµØ§Ù„ Ùˆ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ</button>
    <div class="modal-err" id="mt5DashErr"></div>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div class="toast-wrap" id="toastWrap"></div>

<!-- NOTIFICATION PANEL -->
<div class="notif-panel" id="notifPanel">
  <div class="notif-header">
    <h3>ğŸ”” Ù…Ø±Ú©Ø² Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§</h3>
    <button onclick="markAllRead()">Ø®ÙˆØ§Ù†Ø¯Ù… Ù‡Ù…Ù‡</button>
  </div>
  <div class="notif-tabs">
    <div class="notif-tab active" onclick="switchNotifTab('all',this)">Ù‡Ù…Ù‡</div>
    <div class="notif-tab" onclick="switchNotifTab('unread',this)">Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù†Ø´Ø¯Ù‡</div>
    <div class="notif-tab" onclick="switchNotifTab('alerts',this)">Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ÛŒ ÙØ¹Ø§Ù„</div>
  </div>
  <div class="notif-list" id="notifList"><div class="notif-empty">Ù‡Ù†ÙˆØ² Ø§Ø¹Ù„Ø§Ù†ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</div></div>
</div>

<div class="header">
  <div class="logo">ğŸ§  Whilber-AI <span>ØªØ­Ù„ÛŒÙ„Ú¯Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ | Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ</span></div>




  <div class="controls">
    <select id="selSymbol">
<option value="">Ù†Ù…Ø§Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
<optgroup label="ÙØ§Ø±Ú©Ø³ â€” Ù…Ø§Ú˜ÙˆØ±">
  <option value="EURUSD">EURUSD â€” ÛŒÙˆØ±Ùˆ/Ø¯Ù„Ø§Ø±</option>
  <option value="GBPUSD">GBPUSD â€” Ù¾ÙˆÙ†Ø¯/Ø¯Ù„Ø§Ø±</option>
  <option value="USDJPY">USDJPY â€” Ø¯Ù„Ø§Ø±/ÛŒÙ†</option>
  <option value="USDCHF">USDCHF â€” Ø¯Ù„Ø§Ø±/ÙØ±Ø§Ù†Ú©</option>
  <option value="AUDUSD">AUDUSD â€” Ø§Ø³ØªØ±Ø§Ù„ÛŒØ§/Ø¯Ù„Ø§Ø±</option>
  <option value="NZDUSD">NZDUSD â€” Ù†ÛŒÙˆØ²ÛŒÙ„Ù†Ø¯/Ø¯Ù„Ø§Ø±</option>
  <option value="USDCAD">USDCAD â€” Ø¯Ù„Ø§Ø±/Ú©Ø§Ù†Ø§Ø¯Ø§</option>
</optgroup>
<optgroup label="ÙØ§Ø±Ú©Ø³ â€” ÛŒÙˆØ±Ùˆ Ú©Ø±Ø§Ø³">
  <option value="EURGBP">EURGBP â€” ÛŒÙˆØ±Ùˆ/Ù¾ÙˆÙ†Ø¯</option>
  <option value="EURJPY">EURJPY â€” ÛŒÙˆØ±Ùˆ/ÛŒÙ†</option>
  <option value="EURAUD">EURAUD â€” ÛŒÙˆØ±Ùˆ/Ø§Ø³ØªØ±Ø§Ù„ÛŒØ§</option>
  <option value="EURCAD">EURCAD â€” ÛŒÙˆØ±Ùˆ/Ú©Ø§Ù†Ø§Ø¯Ø§</option>
  <option value="EURCHF">EURCHF â€” ÛŒÙˆØ±Ùˆ/ÙØ±Ø§Ù†Ú©</option>
  <option value="EURNZD">EURNZD â€” ÛŒÙˆØ±Ùˆ/Ù†ÛŒÙˆØ²ÛŒÙ„Ù†Ø¯</option>
</optgroup>
<optgroup label="ÙØ§Ø±Ú©Ø³ â€” Ù¾ÙˆÙ†Ø¯ Ú©Ø±Ø§Ø³">
  <option value="GBPJPY">GBPJPY â€” Ù¾ÙˆÙ†Ø¯/ÛŒÙ†</option>
  <option value="GBPAUD">GBPAUD â€” Ù¾ÙˆÙ†Ø¯/Ø§Ø³ØªØ±Ø§Ù„ÛŒØ§</option>
  <option value="GBPCAD">GBPCAD â€” Ù¾ÙˆÙ†Ø¯/Ú©Ø§Ù†Ø§Ø¯Ø§</option>
  <option value="GBPCHF">GBPCHF â€” Ù¾ÙˆÙ†Ø¯/ÙØ±Ø§Ù†Ú©</option>
  <option value="GBPNZD">GBPNZD â€” Ù¾ÙˆÙ†Ø¯/Ù†ÛŒÙˆØ²ÛŒÙ„Ù†Ø¯</option>
</optgroup>
<optgroup label="ÙØ§Ø±Ú©Ø³ â€” Ø³Ø§ÛŒØ± Ú©Ø±Ø§Ø³">
  <option value="AUDJPY">AUDJPY â€” Ø§Ø³ØªØ±Ø§Ù„ÛŒØ§/ÛŒÙ†</option>
  <option value="AUDNZD">AUDNZD â€” Ø§Ø³ØªØ±Ø§Ù„ÛŒØ§/Ù†ÛŒÙˆØ²ÛŒÙ„Ù†Ø¯</option>
  <option value="AUDCAD">AUDCAD â€” Ø§Ø³ØªØ±Ø§Ù„ÛŒØ§/Ú©Ø§Ù†Ø§Ø¯Ø§</option>
  <option value="AUDCHF">AUDCHF â€” Ø§Ø³ØªØ±Ø§Ù„ÛŒØ§/ÙØ±Ø§Ù†Ú©</option>
  <option value="NZDJPY">NZDJPY â€” Ù†ÛŒÙˆØ²ÛŒÙ„Ù†Ø¯/ÛŒÙ†</option>
  <option value="NZDCAD">NZDCAD â€” Ù†ÛŒÙˆØ²ÛŒÙ„Ù†Ø¯/Ú©Ø§Ù†Ø§Ø¯Ø§</option>
  <option value="NZDCHF">NZDCHF â€” Ù†ÛŒÙˆØ²ÛŒÙ„Ù†Ø¯/ÙØ±Ø§Ù†Ú©</option>
  <option value="CADJPY">CADJPY â€” Ú©Ø§Ù†Ø§Ø¯Ø§/ÛŒÙ†</option>
  <option value="CADCHF">CADCHF â€” Ú©Ø§Ù†Ø§Ø¯Ø§/ÙØ±Ø§Ù†Ú©</option>
  <option value="CHFJPY">CHFJPY â€” ÙØ±Ø§Ù†Ú©/ÛŒÙ†</option>
</optgroup>
<optgroup label="ÙÙ„Ø²Ø§Øª">
  <option value="XAUUSD" selected>XAUUSD â€” Ø·Ù„Ø§</option>
  <option value="XAGUSD">XAGUSD â€” Ù†Ù‚Ø±Ù‡</option>
</optgroup>
<optgroup label="Ú©Ø±ÛŒÙ¾ØªÙˆ">
  <option value="BTCUSD">BTCUSD â€” Ø¨ÛŒØªâ€ŒÚ©ÙˆÛŒÙ†</option>
</optgroup>
<optgroup label="Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§">
  <option value="NAS100">NAS100 â€” Ù†Ø²Ø¯Ú©</option>
  <option value="US30">US30 â€” Ø¯Ø§ÙˆØ¬ÙˆÙ†Ø²</option>
</optgroup>
</select>
    <select id="selTF"><option value="M1">M1</option><option value="M5">M5</option><option value="M15">M15</option><option value="M30">M30</option><option value="H1" selected>H1</option><option value="H4">H4</option><option value="D1">D1</option></select>
    <button class="btn-analyze" id="btnAnalyze" onclick="doAnalyze()">ğŸ” ØªØ­Ù„ÛŒÙ„</button>
    <button class="btn-multi" onclick="doMulti()">ğŸ“Š Ù‡Ù…Ù‡</button>
    <div class="bell-wrap">
      <button class="bell-btn" onclick="toggleNotifPanel()">ğŸ””<span class="bell-badge" id="bellBadge" style="display:none;">0</span></button>
    </div>
    <div class="clock"><span class="clk-icon">ğŸ•</span><span id="localClock">--:--:--</span></div>
    <div class="auto-badge" id="autoRefreshBadge" onclick="toggleAutoRefresh()" title="Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ±">âŸ³ Ø®ÙˆØ¯Ú©Ø§Ø± Û³Û°Ø«</div>
    <span id="mt5Status"></span>
  </div>
</div>

<div class="main">
  <div class="multi-bar" id="multiBar" style="display:none;"></div>
  <div id="content"><div class="loading"><div class="spinner"></div><p style="margin-top:10px;">Ù†Ù…Ø§Ø¯ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ Ùˆ "ØªØ­Ù„ÛŒÙ„" Ø¨Ø²Ù†ÛŒØ¯</p></div></div>
</div>

<script src="/static/plan-ui.js"></script>
<div id="planDailyBar" style="max-width:700px;margin:0 auto 4px;"></div>

<script>
var API='',DEFAULT_MULTI=['EURUSD','GBPUSD','USDJPY','XAUUSD','BTCUSD','NAS100','ETHUSD','SOLUSD'];
var currentData=null,isRegistered=false,pendingAction=null;
function getAuthHeaders(){var h={};try{var t=localStorage.getItem('userToken');if(t)h['Authorization']='Bearer '+t;}catch(e){}return h;}
function showUpsell(msg){var b=document.getElementById('upsellBanner');var t=document.getElementById('upsellText');if(b&&t){t.textContent=msg;b.style.display='block';}}
function hideUpsell(){var b=document.getElementById('upsellBanner');if(b)b.style.display='none';}
function showTruncation(msg){var n=document.getElementById('truncationNotice');if(n){n.textContent=msg;n.style.display='block';}}
function hideTruncation(){var n=document.getElementById('truncationNotice');if(n)n.style.display='none';}
var alertContext={};
var CATEGORIES = [
  {id:"RSI",icon:"ğŸ“ˆ",name:"RSI",color:"#06b6d4"},
  {id:"MACD",icon:"ğŸ“Š",name:"MACD",color:"#8b5cf6"},
  {id:"STOCH",icon:"ğŸ”„",name:"Stochastic",color:"#f59e0b"},
  {id:"BB",icon:"ğŸ“",name:"Bollinger",color:"#ec4899"},
  {id:"MA",icon:"ğŸ“",name:"Moving Average",color:"#10b981"},
  {id:"ICH",icon:"â˜ï¸",name:"Ichimoku",color:"#3b82f6"},
  {id:"ADX",icon:"ğŸ’ª",name:"ADX",color:"#ef4444"},
  {id:"CP",icon:"ğŸ•¯ï¸",name:"Candle Pattern",color:"#f97316"},
  {id:"DIV",icon:"â†—ï¸",name:"Divergence",color:"#a855f7"},
  {id:"VOL",icon:"ğŸ“¢",name:"Volume",color:"#14b8a6"},
  {id:"FIB",icon:"ğŸŒ€",name:"Fibonacci",color:"#eab308"},
  {id:"SM",icon:"ğŸ¦",name:"Smart Money",color:"#6366f1"},
  {id:"CCI",icon:"ã€°ï¸",name:"CCI",color:"#f43f5e"},
  {id:"WR",icon:"ğŸ“‰",name:"Williams %R",color:"#22c55e"},
  {id:"ATR",icon:"ğŸ“",name:"ATR",color:"#0ea5e9"},
  {id:"MOM",icon:"ğŸš€",name:"Momentum",color:"#d946ef"},
  {id:"PVT",icon:"ğŸ“",name:"Pivots",color:"#64748b"},
  {id:"MTF",icon:"â±ï¸",name:"Multi-TF",color:"#f472b6"},
  {id:"PA",icon:"ğŸ¯",name:"Price Action",color:"#fbbf24"},
  {id:"ADP",icon:"ğŸ¤–",name:"Adaptive",color:"#34d399"},
  {id:"DON",icon:"ğŸ“¦",name:"Donchian",color:"#06b6d4"},
  {id:"KC",icon:"ğŸ“",name:"Keltner",color:"#8b5cf6"},
  {id:"ENV",icon:"ğŸ”²",name:"Envelope",color:"#f59e0b"},
  {id:"PSAR",icon:"â­•",name:"Parabolic SAR",color:"#ec4899"},
  {id:"REG",icon:"ğŸ“",name:"Regression",color:"#10b981"},
  {id:"TRIX",icon:"ğŸ”º",name:"TRIX",color:"#3b82f6"},
  {id:"ROC",icon:"ğŸ“ˆ",name:"ROC",color:"#ef4444"},
  {id:"CMO",icon:"ã€½ï¸",name:"CMO",color:"#f97316"},
  {id:"RVI",icon:"ğŸ”ƒ",name:"RVI",color:"#a855f7"},
  {id:"PPO",icon:"ğŸ“Š",name:"PPO",color:"#14b8a6"},
  {id:"OBV",icon:"ğŸ“Š",name:"OBV",color:"#eab308"},
  {id:"MFI",icon:"ğŸ’°",name:"MFI",color:"#6366f1"},
  {id:"VWAP",icon:"ğŸ“ˆ",name:"VWAP",color:"#f43f5e"},
  {id:"AD",icon:"ğŸ“‰",name:"A/D Line",color:"#22c55e"},
  {id:"FI",icon:"ğŸ’ª",name:"Force Index",color:"#0ea5e9"},
  {id:"ADX_ADV",icon:"ğŸ’ª",name:"ADX Advanced",color:"#d946ef"},
  {id:"STREND",icon:"ğŸ“ˆ",name:"SuperTrend",color:"#64748b"},
  {id:"ARN",icon:"ğŸ¹",name:"Aroon",color:"#f472b6"},
  {id:"DPO",icon:"ğŸ“‰",name:"DPO",color:"#fbbf24"},
  {id:"VTX",icon:"ğŸŒ€",name:"Vortex",color:"#34d399"},
  {id:"ELDER",icon:"âš¡",name:"Elder Ray",color:"#06b6d4"},
  {id:"FISHER",icon:"ğŸŸ",name:"Fisher",color:"#8b5cf6"},
  {id:"HEIKIN",icon:"ğŸ•¯ï¸",name:"Heikin Ashi",color:"#f59e0b"},
  {id:"CHOP",icon:"ğŸŒŠ",name:"Choppiness",color:"#ec4899"},
  {id:"MASS",icon:"ğŸ“Š",name:"Mass Index",color:"#10b981"},
  {id:"PIVOT_ADV",icon:"ğŸ“",name:"Pivot Advanced",color:"#3b82f6"},
  {id:"GAPS",icon:"ğŸ“­",name:"Gap Analysis",color:"#ef4444"},
  {id:"RANGE",icon:"ğŸ“¦",name:"Range",color:"#f97316"},
  {id:"SWING",icon:"ğŸ”„",name:"Swing",color:"#a855f7"},
  {id:"HARMONIC",icon:"ğŸ¦‹",name:"Harmonic",color:"#14b8a6"},
  {id:"COMBO",icon:"ğŸ¯",name:"Combo",color:"#eab308"},
  {id:"ST",icon:"ğŸ“ˆ",name:"SuperTrend",color:"#64748b"},
  {id:"SRSI",icon:"ğŸ”",name:"StochRSI",color:"#f43f5e"},
  {id:"ULT",icon:"ğŸ¯",name:"Ultimate",color:"#22c55e"},
  {id:"EW",icon:"ğŸŒŠ",name:"Elliott Wave",color:"#0ea5e9"},
  {id:"COR",icon:"ğŸ”—",name:"Correlation",color:"#d946ef"},
  {id:"HARM",icon:"ğŸ¦‹",name:"Harmonic",color:"#14b8a6"},
];
function getCat(id){for(var c of CATEGORIES){if(!c.prefixes){if(id.startsWith(c.id+"_"))return c.id;}else{for(var p of c.prefixes){if(id.startsWith(p))return c.id;}}}return "CORE";}

/* â•â•â•â•â•â• USER â•â•â•â•â•â• */
function getUser(){try{return JSON.parse(localStorage.getItem('wai_user'));}catch(e){return null;}}
function checkReg(){var u=getUser();if(u){isRegistered=true;document.getElementById('regModal').style.display='none';return true;}document.getElementById('regModal').style.display='none';return false;}
async function doRegister(){
  var name=document.getElementById('regName').value.trim(),email=document.getElementById('regEmail').value.trim(),phone=document.getElementById('regPhone').value.trim();
  var err=document.getElementById('regErr'),btn=document.getElementById('regBtn');
  if(!name){err.textContent='Ù†Ø§Ù… ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯';return;}if(!email||!email.includes('@')){err.textContent='Ø§ÛŒÙ…ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯';return;}
  btn.disabled=true;btn.textContent='...';err.textContent='';
  try{var r=await fetch(API+'/api/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:name,email:email,phone:phone})});
  var d=await r.json();if(d.success){localStorage.setItem('wai_user',JSON.stringify({name:name,email:email,id:d.user_id}));isRegistered=true;
  document.getElementById('regModal').style.display='none';if(pendingAction==='analyze')doAnalyze();else if(pendingAction==='multi')doMulti();pendingAction=null;}
  else{err.textContent=d.error||'Ø®Ø·Ø§';}}catch(e){err.textContent='Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±';}finally{btn.disabled=false;btn.textContent='Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ùˆ ÙˆØ±ÙˆØ¯';}}

/* â•â•â•â•â•â• TOAST â•â•â•â•â•â• */
function showToast(icon,title,msg,dur){
  dur=dur||5000;var wrap=document.getElementById('toastWrap');
  var t=document.createElement('div');t.className='toast';
  t.innerHTML='<span class="t-icon">'+icon+'</span><div class="t-body"><div class="t-title">'+title+'</div><div class="t-msg">'+msg+'</div></div><button class="t-close" onclick="this.parentElement.remove()">âœ•</button>';
  wrap.appendChild(t);setTimeout(function(){t.classList.add('leaving');setTimeout(function(){t.remove();},300);},dur);
}

/* â•â•â•â•â•â• NOTIFICATION PANEL â•â•â•â•â•â• */
function toggleNotifPanel(){var p=document.getElementById('notifPanel');p.classList.toggle('show');if(p.classList.contains('show'))loadNotifications();}
async function loadNotifications(mode){
  mode=mode||'all';var u=getUser();if(!u)return;
  var list=document.getElementById('notifList');
  try{var url=API+'/api/notifications?email='+encodeURIComponent(u.email)+'&limit=50';
  if(mode==='unread')url+='&unread=true';
  var r=await fetch(url);var d=await r.json();
  if(mode==='alerts'){await loadActiveAlerts();return;}
  var notifs=d.notifications||[];
  if(!notifs.length){list.innerHTML='<div class="notif-empty">Ù‡Ù†ÙˆØ² Ø§Ø¹Ù„Ø§Ù†ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</div>';return;}
  list.innerHTML='';for(var n of notifs){
    var item=document.createElement('div');item.className='notif-item'+(n.read?'':' unread');
    item.innerHTML='<div class="ni-head"><span class="ni-icon">'+n.icon+'</span><span class="ni-title">'+n.title+'</span><span class="ni-time">'+timeAgo(n.created_at)+'</span></div><div class="ni-body">'+n.body+'</div>';
    item.onclick=(function(nid){return function(){markNotifRead(nid);};})(n.id);
    list.appendChild(item);}
  updateBadge(d.unread_count);}catch(e){list.innerHTML='<div class="notif-empty">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</div>';}
}
async function loadActiveAlerts(){
  var u=getUser();if(!u)return;var list=document.getElementById('notifList');
  try{var r=await fetch(API+'/api/alerts?email='+encodeURIComponent(u.email));var d=await r.json();var alerts=d.alerts||[];
  if(!alerts.length){list.innerHTML='<div class="notif-empty">Ù‡Ø´Ø¯Ø§Ø± ÙØ¹Ø§Ù„ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</div>';return;}
  list.innerHTML='';for(var a of alerts){
    var item=document.createElement('div');item.className='notif-item';
    item.innerHTML='<div class="ni-head"><span class="ni-icon">'+a.icon+'</span><span class="ni-title">'+a.symbol+' â€” '+a.alert_type_fa+'</span><span class="ni-time">'+a.timeframe+'</span></div>'+(a.strategy_id?'<div class="ni-body">Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ: '+a.strategy_id+'</div>':'<div class="ni-body">Ø³ØªØ§Ù¾ Ú©Ù„ÛŒ</div>')+'<button style="font-size:10px;padding:2px 8px;min-height:auto;color:var(--red);border-color:var(--red);margin-top:4px;" onclick="event.stopPropagation();deleteAlertById(\''+a.id+'\')">Ø­Ø°Ù</button>';
    list.appendChild(item);}
  }catch(e){list.innerHTML='<div class="notif-empty">Ø®Ø·Ø§</div>';}
}
async function markNotifRead(nid){var u=getUser();if(!u)return;await fetch(API+'/api/notifications/read?email='+encodeURIComponent(u.email)+'&notif_id='+nid,{method:'POST'});loadNotifications();}
async function markAllRead(){var u=getUser();if(!u)return;await fetch(API+'/api/notifications/read?email='+encodeURIComponent(u.email),{method:'POST'});loadNotifications();updateBadge(0);}
function switchNotifTab(mode,el){document.querySelectorAll('.notif-tab').forEach(function(t){t.classList.remove('active');});el.classList.add('active');loadNotifications(mode);}
async function updateBadge(cnt){
  if(cnt===undefined){var u=getUser();if(!u)return;try{var r=await fetch(API+'/api/notifications/count?email='+encodeURIComponent(u.email));var d=await r.json();cnt=d.count;}catch(e){cnt=0;}}
  var b=document.getElementById('bellBadge');if(cnt>0){b.style.display='flex';b.textContent=cnt>99?'99+':cnt;}else{b.style.display='none';}
}
async function deleteAlertById(aid){var u=getUser();if(!u)return;await fetch(API+'/api/alerts/'+aid+'?email='+encodeURIComponent(u.email),{method:'DELETE'});loadActiveAlerts();showToast('ğŸ—‘ï¸','Ø­Ø°Ù Ø´Ø¯','Ù‡Ø´Ø¯Ø§Ø± Ø­Ø°Ù Ø´Ø¯',2000);}
function timeAgo(iso){var d=new Date(iso),now=new Date(),s=Math.floor((now-d)/1000);if(s<60)return 'Ø§Ù„Ø§Ù†';if(s<3600)return Math.floor(s/60)+'Ø¯';if(s<86400)return Math.floor(s/3600)+'Ø³';return Math.floor(s/86400)+'Ø±';}

/* â•â•â•â•â•â• ALERT MODAL â•â•â•â•â•â• */
var ALERT_TYPES_DATA={
  signal_change:{icon:'ğŸ”„',name:'ØªØºÛŒÛŒØ± Ø³ÛŒÚ¯Ù†Ø§Ù„'},signal_buy:{icon:'ğŸŸ¢',name:'Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø®Ø±ÛŒØ¯'},signal_sell:{icon:'ğŸ”´',name:'Ø³ÛŒÚ¯Ù†Ø§Ù„ ÙØ±ÙˆØ´'},
  tp1_hit:{icon:'âœ…',name:'Ø±Ø³ÛŒØ¯Ù† TP1'},tp2_hit:{icon:'ğŸ†',name:'Ø±Ø³ÛŒØ¯Ù† TP2'},sl_hit:{icon:'ğŸ›‘',name:'ÙØ¹Ø§Ù„ Ø´Ø¯Ù† SL'},
  confidence_high:{icon:'â­',name:'Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¨Ø§Ù„Ø§'},master_active:{icon:'ğŸ“‹',name:'Ø³ØªØ§Ù¾ Ú©Ù„ÛŒ ÙØ¹Ø§Ù„'},master_change:{icon:'ğŸ”€',name:'ØªØºÛŒÛŒØ± Ø³ØªØ§Ù¾'}
};
function showAlertModal(symbol,tf,stratId,stratName,setup){
  alertContext={symbol:symbol,timeframe:tf,strategy_id:stratId,strategy_name:stratName,setup:setup};
  document.getElementById('alertModalSub').textContent=symbol+' | '+tf+(stratName?' | '+stratName:' | Ø³ØªØ§Ù¾ Ú©Ù„ÛŒ');
  var grid=document.getElementById('alertTypeGrid');grid.innerHTML='';
  var types=stratId?['signal_change','signal_buy','signal_sell','confidence_high']:['master_active','master_change'];
  if(setup&&setup.has_setup){
    if(setup.tp1)types.push('tp1_hit');
    if(setup.tp2)types.push('tp2_hit');
    if(setup.stop_loss)types.push('sl_hit');
  }
  for(var t of types){var info=ALERT_TYPES_DATA[t];if(!info)continue;
    var opt=document.createElement('div');opt.className='alert-type-opt';opt.dataset.type=t;
    opt.innerHTML='<span class="ato-icon">'+info.icon+'</span><span class="ato-name">'+info.name+'</span>';
    opt.onclick=function(){document.querySelectorAll('.alert-type-opt').forEach(function(o){o.classList.remove('selected');});this.classList.add('selected');};
    grid.appendChild(opt);}
  var u=getUser();if(u)document.getElementById('alertEmail').value=u.email;
  document.getElementById('alertErr').textContent='';
  document.getElementById('alertModal').classList.add('show');
}
function hideAlertModal(){document.getElementById('alertModal').classList.remove('show');}
async function submitAlert(){
  var sel=document.querySelector('.alert-type-opt.selected');if(!sel){document.getElementById('alertErr').textContent='Ù†ÙˆØ¹ Ù‡Ø´Ø¯Ø§Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯';return;}
  var atype=sel.dataset.type;var email=document.getElementById('alertEmail').value.trim();
  if(!email||!email.includes('@')){document.getElementById('alertErr').textContent='Ø§ÛŒÙ…ÛŒÙ„ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯';return;}
  var btn=document.getElementById('alertBtn');btn.disabled=true;
  var target=null;var setup=alertContext.setup;
  if(atype==='tp1_hit'&&setup)target=setup.tp1;
  if(atype==='tp2_hit'&&setup)target=setup.tp2;
  if(atype==='sl_hit'&&setup)target=setup.stop_loss;
  try{var r=await fetch(API+'/api/alerts',{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({user_email:email,symbol:alertContext.symbol,timeframe:alertContext.timeframe,alert_type:atype,strategy_id:alertContext.strategy_id||null,target_price:target})});
    var d=await r.json();if(d.success){hideAlertModal();showToast('ğŸ””','Ù‡Ø´Ø¯Ø§Ø± ÙØ¹Ø§Ù„ Ø´Ø¯',alertContext.symbol+' â€” '+ALERT_TYPES_DATA[atype].name,3000);}
    else{document.getElementById('alertErr').textContent=d.error||'Ø®Ø·Ø§';}
  }catch(e){document.getElementById('alertErr').textContent='Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±';}finally{btn.disabled=false;}
}

/* â•â•â•â•â•â• MT5 CONNECTION â•â•â•â•â•â• */
var _mt5DashData={};
function openMT5Dash(stratId,sym,name,dir,entry,sl,tp){
  _mt5DashData={strategy_id:stratId,symbol:sym,name:name,direction:dir,entry:entry,sl:sl,tp:tp};
  document.getElementById('mt5DashStrat').textContent=name||stratId;
  document.getElementById('mt5DashSym').textContent=sym||'-';
  document.getElementById('mt5DashSub').textContent=(name||stratId)+' | '+(sym||'')+(dir?' | '+dir+' @ '+(entry||'-'):'');
  document.getElementById('mt5DashErr').textContent='';
  // Auto-fill lot size based on symbol
  var lotEl=document.getElementById('mt5DashLot');
  if(lotEl){var defaults={'XAUUSD':0.01,'BTCUSD':0.01,'EURUSD':0.1,'GBPUSD':0.1,'USDJPY':0.1,'US30':0.1,'NAS100':0.1};lotEl.value=defaults[sym]||0.01;}
  loadMT5DashAccounts();
  document.getElementById('mt5ModalDash').classList.add('show');
}
function closeMT5Dash(){document.getElementById('mt5ModalDash').classList.remove('show');}
async function loadMT5DashAccounts(){
  try{var r=await fetch(API+'/api/mt5/accounts');var d=await r.json();var accs=d.accounts||[];
  var sel=document.getElementById('mt5DashExistingAcc');sel.innerHTML='<option value="">+ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÛŒØ¯</option>';
  accs.forEach(function(a){sel.innerHTML+='<option value="'+a.id+'">'+a.account_number+' | '+a.server+'</option>';});
  if(accs.length>0){document.getElementById('mt5DashAccSelect').style.display='block';}else{document.getElementById('mt5DashAccSelect').style.display='none';}
  }catch(e){}
}
async function saveMT5Dash(){
  var existingId=document.getElementById('mt5DashExistingAcc').value;
  var payload;
  if(existingId){
    payload={account_id:existingId,strategy_id:_mt5DashData.strategy_id,symbol:_mt5DashData.symbol,lot_size:parseFloat(document.getElementById('mt5DashLot').value)||0.01};
  }else{
    var accNum=document.getElementById('mt5DashAccNum').value.trim();
    var pass=document.getElementById('mt5DashPass').value;
    var server=document.getElementById('mt5DashServer').value.trim();
    if(!accNum||!pass||!server){document.getElementById('mt5DashErr').textContent='Ø´Ù…Ø§Ø±Ù‡ Ø­Ø³Ø§Ø¨ØŒ Ø±Ù…Ø² Ùˆ Ø³Ø±ÙˆØ± Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª';return;}
    payload={account_number:accNum,password:pass,server:server,platform:'mt5',strategy_id:_mt5DashData.strategy_id,symbol:_mt5DashData.symbol,lot_size:parseFloat(document.getElementById('mt5DashLot').value)||0.01};
  }
  try{var r=await fetch(API+'/api/mt5/link',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  var d=await r.json();if(d.success){closeMT5Dash();showToast('âš¡','MT5 Ù…ØªØµÙ„ Ø´Ø¯',_mt5DashData.symbol+' â€” '+_mt5DashData.name,3000);}
  else{document.getElementById('mt5DashErr').textContent=d.error||'Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„';}
  }catch(e){document.getElementById('mt5DashErr').textContent='Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±';}
}

/* â•â•â•â•â•â• INIT â•â•â•â•â•â• */
async function init(){checkReg();await loadSymbols();checkHealth();updateBadge();setInterval(function(){checkHealth();updateBadge();},30000);}
async function checkHealth(){try{var r=await fetch(API+'/api/health');var d=await r.json();document.getElementById('mt5Status').innerHTML=d.mt5_connected?'<span class="status-dot status-ok"></span>':'<span class="status-dot status-err"></span>';}catch(e){document.getElementById('mt5Status').innerHTML='<span class="status-dot status-err"></span>';}}
async function loadSymbols(){try{var r=await fetch(API+'/api/symbols');var d=await r.json();var sel=document.getElementById('selSymbol');sel.innerHTML='';for(var cat in d.categories||d.groups){var og=document.createElement('optgroup');og.label=cat;for(var s of d.categories||d.groups[cat]){var opt=document.createElement('option');opt.value=s.symbol;opt.textContent=s.symbol+' â€” '+s.name_fa;og.appendChild(opt);}sel.appendChild(og);}}catch(e){}}

/* â•â•â•â•â•â• ANALYZE â•â•â•â•â•â• */
async function doAnalyze(){
  if(!isRegistered){pendingAction='analyze';document.getElementById('regModal').style.display='flex';return;}
  var sym=document.getElementById('selSymbol').value,tf=document.getElementById('selTF').value,btn=document.getElementById('btnAnalyze');
  btn.disabled=true;btn.textContent='â³';document.getElementById('content').innerHTML='<div class="loading"><div class="spinner"></div><p style="margin-top:10px;">ØªØ­Ù„ÛŒÙ„ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ...</p></div>';
  document.getElementById('multiBar').style.display='none';hideUpsell();hideTruncation();
  try{var r=await fetch(API+'/api/analyze3/'+sym+'/'+tf,{headers:getAuthHeaders()});
  if(r.status===403){var err=await r.json();var detail=err.detail||err;var msg=typeof detail==='object'?detail.error||'Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù¾Ù„Ù†':detail;showUpsell(msg);document.getElementById('content').innerHTML='';btn.disabled=false;btn.textContent='ğŸ” ØªØ­Ù„ÛŒÙ„';return;}
  if(!r.ok){var e=await r.json();throw new Error(e.detail||'Ø®Ø·Ø§');}
  currentData=await r.json();renderAnalysis(currentData);
  if(currentData.strategies_truncated){showTruncation('Ù†Ù…Ø§ÛŒØ´ '+currentData.strategies.length+' Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ Ø§Ø² Ú©Ù„ â€” Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù‡Ù…Ù‡ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒâ€ŒÙ‡Ø§ Ù¾Ù„Ù† Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±ØªÙ‚Ø§ Ø¯Ù‡ÛŒØ¯');}
  if(currentData.triggered_alerts){for(var ta of currentData.triggered_alerts){showToast(ta.icon||'ğŸ””',ta.title,ta.body,7000);}}
  }catch(e){document.getElementById('content').innerHTML='<div class="card" style="text-align:center;color:var(--red);padding:30px;">âŒ '+e.message+'</div>';}
  finally{btn.disabled=false;btn.textContent='ğŸ” ØªØ­Ù„ÛŒÙ„';}}

async function doMulti(){if(!isRegistered){pendingAction='multi';document.getElementById('regModal').style.display='flex';return;}
  var tf=document.getElementById('selTF').value,btn=document.getElementById('btnAnalyze');btn.disabled=true;hideUpsell();hideTruncation();
  document.getElementById('content').innerHTML='<div class="loading"><div class="spinner"></div><p>ØªØ­Ù„ÛŒÙ„ Ú†Ù†Ø¯ Ù†Ù…Ø§Ø¯ÛŒ...</p></div>';
  try{var r=await fetch(API+'/api/multi/'+DEFAULT_MULTI.join(',')+('?timeframe='+tf));var d=await r.json();renderMultiBar(d.results,tf);
  var first=Object.keys(d.results)[0];if(first){document.getElementById('selSymbol').value=first;var det=await fetch(API+'/api/analyze3/'+first+'/'+tf,{headers:getAuthHeaders()});currentData=await det.json();renderAnalysis(currentData);}}
  catch(e){document.getElementById('content').innerHTML='<div class="card" style="color:var(--red);">âŒ '+e.message+'</div>';}finally{btn.disabled=false;}}

function renderMultiBar(results,tf){var bar=document.getElementById('multiBar');bar.style.display='flex';bar.innerHTML='';
for(var sym in results){var data=results[sym];if(data.error)continue;
(function(s,d){var chip=document.createElement('div');chip.className='multi-chip';
chip.onclick=async function(){document.getElementById('selSymbol').value=s;document.querySelectorAll('.multi-chip').forEach(function(c){c.classList.remove('active');});chip.classList.add('active');
document.getElementById('content').innerHTML='<div class="loading"><div class="spinner"></div></div>';var r=await fetch(API+'/api/analyze3/'+s+'/'+tf,{headers:getAuthHeaders()});if(r.status===403){var err=await r.json();var detail=err.detail||err;showUpsell(typeof detail==='object'?detail.error:'Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù¾Ù„Ù†');return;}currentData=await r.json();renderAnalysis(currentData);};
var sc=d.signal==='BUY'?'var(--green)':d.signal==='SELL'?'var(--red)':'var(--yellow)';
chip.innerHTML='<div class="sym-name">'+s+'</div><div class="sym-signal" style="color:'+sc+'">'+d.signal_fa+'</div><div class="sym-conf">'+d.confidence+'%</div>';bar.appendChild(chip);})(sym,data);}}

/* â•â•â•â•â•â• RENDER â•â•â•â•â•â• */
function renderAnalysis(data){
  var o=data.overall,sigFa=o.signal==='BUY'?'ğŸŸ¢ Ø®Ø±ÛŒØ¯':o.signal==='SELL'?'ğŸ”´ ÙØ±ÙˆØ´':'ğŸŸ¡ Ø®Ù†Ø«ÛŒ';
  var confColor=o.signal==='BUY'?'var(--green)':o.signal==='SELL'?'var(--red)':'var(--yellow)';
  var c=data.context||{},sCount=data.strategies?data.strategies.length:0;
  var html='<div class="signal-card"><div style="color:var(--text2);font-size:12px;">'+(data.symbol_fa||'')+' | '+data.symbol+' '+data.timeframe+'</div>'+'<div class="signal-badge signal-'+o.signal+'">'+sigFa+'</div>'+'<div class="conf-bar"><div class="conf-fill" style="width:'+o.confidence+'%;background:'+confColor+';"></div></div>'+'<div style="font-size:16px;font-weight:700;">'+o.confidence+'% Ø§Ø·Ù…ÛŒÙ†Ø§Ù†</div>'+'<div class="signal-summary">'+(o.summary_fa||'')+'</div>'+'<div class="signal-meta"><span class="vote-buy">Ø®Ø±ÛŒØ¯: '+o.buy_count+'</span><span class="vote-sell">ÙØ±ÙˆØ´: '+o.sell_count+'</span><span>Ø®Ù†Ø«ÛŒ: '+o.neutral_count+'</span></div>'+'<div class="perf"><span>âš¡ '+fix(data.performance?data.performance.total_time:0,2)+'s</span><span>ğŸ“Š '+(data.performance?data.performance.bars_analyzed:'?')+' Ú©Ù†Ø¯Ù„</span><span>ğŸ§  '+sCount+'</span></div></div>';
  html+=renderMasterSetup(data.master_setup,data);
  html+='<div class="grid"><div class="card"><div class="card-title">ğŸ’° Ù‚ÛŒÙ…Øª</div><div class="price-big">'+(data.last_close||'â€”')+'</div>'+(data.price&&data.price.bid?'<div class="price-spread">Bid: '+data.price.bid+' | Ask: '+data.price.ask+' | Spread: '+data.price.spread+'</div>':'')+'<div style="margin-top:8px;">'+ctx('Ø±Ú˜ÛŒÙ…',c.regime)+ctx('ADX',fix(c.adx,1))+ctx('RSI',fix(c.rsi_14,1))+ctx('Stoch K',fix(c.stoch_k,1))+ctx('ATR%',fix(c.atr_percent,4))+ctx('EMA 9',fix(c.ema_9,5))+ctx('EMA 50',fix(c.ema_50,5))+ctx('MA Stack',c.ma_stack==1?'ğŸ“ˆ':c.ma_stack==-1?'ğŸ“‰':'â†”ï¸')+ctx('SuperTrend',c.supertrend_dir==1?'ğŸ“ˆ':c.supertrend_dir==-1?'ğŸ“‰':'â€”')+'</div></div>';
  html+='<div class="card"><div class="card-title">ğŸ“‹ '+sCount+' Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ <span style="font-size:10px;color:var(--text3);margin-right:auto;">ğŸ”” = Ù‡Ø´Ø¯Ø§Ø± | âš¡ = MT5 | â–¶ = Ø³ØªØ§Ù¾</span></div><div class="filter-tabs"><div class="filter-tab active" onclick="filterStrats(\'all\',this)">Ù‡Ù…Ù‡</div><div class="filter-tab" onclick="filterStrats(\'BUY\',this)" style="color:var(--green);">Ø®Ø±ÛŒØ¯</div><div class="filter-tab" onclick="filterStrats(\'SELL\',this)" style="color:var(--red);">ÙØ±ÙˆØ´</div><div class="filter-tab" onclick="filterStrats(\'NEUTRAL\',this)">Ø®Ù†Ø«ÛŒ</div></div><div class="strats-panel">'+renderCatStrats(data)+'</div></div></div>';
  document.getElementById('content').innerHTML=html;
}

function renderMasterSetup(ms,data){
  if(!ms||!ms.has_setup){return '<div class="setup-master setup-NONE"><div class="setup-title-bar"><span class="setup-label">ğŸ“‹ Ø³ØªØ§Ù¾ Ú©Ù„ÛŒ</span><button class="alert-trigger" onclick="event.stopPropagation();showAlertModal(\''+data.symbol+'\',\''+data.timeframe+'\',null,null,null)">ğŸ””</button></div><div class="setup-nosetup">âš ï¸ '+(ms&&ms.reason_fa?ms.reason_fa:'Ø³ØªØ§Ù¾ ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª')+'</div></div>';}
  var dir=ms.direction==='BUY'?'BUY':'SELL',dirC=dir==='BUY'?'var(--green)':'var(--red)';
  var escMs=JSON.stringify(ms).replace(/'/g,"\\'").replace(/"/g,'&quot;');
  return '<div class="setup-master setup-'+dir+'"><div class="setup-title-bar"><span class="setup-label">ğŸ“‹ Ø³ØªØ§Ù¾ Ú©Ù„ÛŒ</span><span style="color:'+dirC+';font-weight:800;font-size:15px;">'+ms.direction_fa+'</span><span class="setup-quality">'+ms.quality_stars+' '+ms.quality+'</span><button class="alert-trigger" onclick="event.stopPropagation();showAlertModal(\''+data.symbol+'\',\''+data.timeframe+'\',null,null,currentData.master_setup)" title="ØªÙ†Ø¸ÛŒÙ… Ù‡Ø´Ø¯Ø§Ø±">ğŸ””</button><button class="mt5-trigger" onclick="event.stopPropagation();openMT5Dash(\'master_setup\',\''+data.symbol+'\',\'Ø³ØªØ§Ù¾ Ú©Ù„ÛŒ\',\''+ms.direction+'\','+ms.entry+','+ms.stop_loss+','+ms.tp1+')" title="Ø§ØªØµØ§Ù„ MT5">âš¡</button></div><div class="setup-levels"><div class="setup-level entry"><div class="lbl">ğŸ¯ ÙˆØ±ÙˆØ¯</div><div class="val">'+ms.entry+'</div></div><div class="setup-level sl"><div class="lbl">ğŸ›‘ SL</div><div class="val">'+ms.stop_loss+'</div></div><div class="setup-level tp1"><div class="lbl">âœ… TP1</div><div class="val">'+ms.tp1+'</div></div><div class="setup-level tp2"><div class="lbl">ğŸ† TP2</div><div class="val">'+ms.tp2+'</div></div></div><div class="setup-rr"><span>R:R TP1=1:'+ms.rr1+'</span><span>R:R TP2=1:'+ms.rr2+'</span><span>ATR:'+ms.atr+'</span><span>ØªÙˆØ§ÙÙ‚:'+ms.agreement_pct+'%</span></div><div class="setup-note">'+(ms.tf_guide_fa?'â± '+ms.tf_guide_fa+' | ':'')+ms.lot_hint_fa+'</div></div>';
}

function renderCatStrats(data){
  var strats=data.strategies||[],grouped={},catOrder=[];
  for(var c of CATEGORIES){grouped[c.id]=[];catOrder.push(c.id);}
  for(var s of strats){var cid=getCat(s.strategy_id);if(!grouped[cid])grouped[cid]=[];grouped[cid].push(s);}
  var html='';for(var cid of catOrder){var items=grouped[cid];if(!items||!items.length)continue;
  var cat=CATEGORIES.find(function(c){return c.id===cid;});if(!cat)continue;
  var bC=0,sC=0;for(var it of items){if(it.signal==='BUY')bC++;else if(it.signal==='SELL')sC++;}
  var catSig='';if(bC>0||sC>0)catSig='<span style="font-size:11px;margin-left:4px;">'+(bC?'<span style="color:var(--green);">â–²'+bC+'</span>':'')+(sC?'<span style="color:var(--red);margin-right:3px;">â–¼'+sC+'</span>':'')+'</span>';
  html+='<div class="cat-group" data-cat="'+cid+'"><div class="cat-header" onclick="toggleCat(this)"><span class="cat-icon">'+cat.icon+'</span><span class="cat-name" style="color:'+cat.color+';">'+cat.name+'</span>'+catSig+'<span class="cat-badge">'+items.length+'</span><span class="cat-arrow">â–¶</span></div><div class="cat-body">';
  items.sort(function(a,b){if(a.signal!=='NEUTRAL'&&b.signal==='NEUTRAL')return -1;if(a.signal==='NEUTRAL'&&b.signal!=='NEUTRAL')return 1;return b.confidence-a.confidence;});
  for(var i=0;i<items.length;i++){var s=items[i],setup=s.setup,hasSetup=setup&&setup.has_setup;
  var _mt5setup=hasSetup?'\''+setup.direction+'\','+setup.entry+','+setup.stop_loss+','+setup.tp1:'null,0,0,0';
  html+='<div class="strat-item" data-sig="'+s.signal+'" onclick="toggleStrat(this)"><span class="strat-sig strat-sig-'+s.signal+'">'+(s.signal_fa||s.signal)+'</span><span class="strat-conf">'+(s.confidence>0?s.confidence+'%':'â€”')+'</span><span class="strat-name">'+(s.strategy_name_fa||s.strategy_id)+'</span><button class="alert-trigger" onclick="event.stopPropagation();showAlertModal(\''+data.symbol+'\',\''+data.timeframe+'\',\''+s.strategy_id+'\',\''+(s.strategy_name_fa||s.strategy_id).replace(/'/g,'')+'\','+JSON.stringify(setup||{}).replace(/"/g,'&quot;')+')" title="Ù‡Ø´Ø¯Ø§Ø±">ğŸ””</button><button class="mt5-trigger" onclick="event.stopPropagation();openMT5Dash(\''+s.strategy_id+'\',\''+data.symbol+'\',\''+(s.strategy_name_fa||s.strategy_id).replace(/'/g,'')+'\','+_mt5setup+')" title="Ø§ØªØµØ§Ù„ MT5">âš¡</button><span class="strat-arrow">â–¶</span></div>';
  html+='<div class="strat-detail">';
  if(s.reason_fa)html+='<div class="reason-line">ğŸ“ '+s.reason_fa+'</div>';
  if(hasSetup){html+='<div class="mini-setup"><div style="color:var(--cyan);font-weight:700;font-size:11px;margin-bottom:3px;">ğŸ“˜ Ø³ØªØ§Ù¾ â€” '+setup.direction_fa+'</div><div class="ms-row"><span class="ms-label">ğŸ¯ ÙˆØ±ÙˆØ¯:</span><span class="ms-val" style="color:var(--cyan);">'+setup.entry+'</span></div><div class="ms-row"><span class="ms-label">ğŸ›‘ SL:</span><span class="ms-val" style="color:var(--red);">'+setup.stop_loss+'</span></div><div class="ms-row"><span class="ms-label">âœ… TP1:</span><span class="ms-val" style="color:var(--green);">'+setup.tp1+'</span></div><div class="ms-row"><span class="ms-label">ğŸ† TP2:</span><span class="ms-val" style="color:var(--green);">'+setup.tp2+'</span></div><div class="ms-row"><span class="ms-label">R:R:</span><span class="ms-val">1:'+setup.rr1+' / 1:'+setup.rr2+'</span></div></div>';}
  else{html+='<div class="ms-nosetup">âš ï¸ '+(setup?setup.reason_fa:'Ø³ØªØ§Ù¾ ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª')+'</div>';}
  html+='</div>';}
  html+='</div></div>';}return html;}

function toggleCat(el){el.classList.toggle('open');}
function toggleStrat(el){var det=el.nextElementSibling;if(!det||!det.classList.contains('strat-detail'))return;el.classList.toggle('open');det.classList.toggle('show');}
function filterStrats(sig,tabEl){document.querySelectorAll('.filter-tab').forEach(function(t){t.classList.remove('active');});tabEl.classList.add('active');
document.querySelectorAll('.strat-item').forEach(function(item){if(sig==='all'){item.style.display='';return;}item.style.display=item.dataset.sig===sig?'':'none';
var det=item.nextElementSibling;if(det&&det.classList.contains('strat-detail')&&item.style.display==='none'){det.classList.remove('show');item.classList.remove('open');}});
document.querySelectorAll('.cat-group').forEach(function(grp){var vis=0;grp.querySelectorAll('.strat-item').forEach(function(i){if(i.style.display!=='none')vis++;});grp.style.display=vis>0?'':'none';});}
function ctx(l,v){return '<div class="ctx-row"><span class="ctx-label">'+l+'</span><span class="ctx-val">'+(v!=null?v:'â€”')+'</span></div>';}
function fix(v,d){return v!=null?Number(v).toFixed(d):'â€”';}
// Close panels on click outside
document.addEventListener('click',function(e){var np=document.getElementById('notifPanel');if(np.classList.contains('show')&&!np.contains(e.target)&&!e.target.classList.contains('bell-btn')&&!e.target.closest('.bell-wrap')){np.classList.remove('show');}});

// â•â•â•â•â•â• LOCAL CLOCK â•â•â•â•â•â•
function updateClock(){
  var now=new Date();
  var h=String(now.getHours()).padStart(2,'0');
  var m=String(now.getMinutes()).padStart(2,'0');
  var s=String(now.getSeconds()).padStart(2,'0');
  var el=document.getElementById('localClock');
  if(el) el.textContent=h+':'+m+':'+s;
}
setInterval(updateClock,1000);
updateClock();

// â•â•â•â•â•â• AUTO-REFRESH â•â•â•â•â•â•
var autoRefreshEnabled=true;
var autoRefreshInterval=30; // seconds
var autoRefreshTimer=null;
var countdownTimer=null;
var countdownLeft=autoRefreshInterval;
var lastAnalysisTime=null;

function toggleAutoRefresh(){
  autoRefreshEnabled=!autoRefreshEnabled;
  var badge=document.getElementById('autoRefreshBadge');
  if(autoRefreshEnabled){
    badge.textContent='\u27F3 \u062E\u0648\u062F\u06A9\u0627\u0631 '+autoRefreshInterval+'\u062B';
    badge.classList.remove('off');
    startAutoRefresh();
  }else{
    badge.textContent='\u23F8 \u063A\u06CC\u0631\u0641\u0639\u0627\u0644';
    badge.classList.add('off');
    stopAutoRefresh();
  }
}

function startAutoRefresh(){
  stopAutoRefresh();
  countdownLeft=autoRefreshInterval;
  autoRefreshTimer=setInterval(function(){
    countdownLeft--;
    updateCountdown();
    if(countdownLeft<=0){
      countdownLeft=autoRefreshInterval;
      autoAnalyze();
    }
  },1000);
}

function stopAutoRefresh(){
  if(autoRefreshTimer){clearInterval(autoRefreshTimer);autoRefreshTimer=null;}
}

function updateCountdown(){
  var bar=document.querySelector('.countdown-fill');
  if(bar){
    var pct=((autoRefreshInterval-countdownLeft)/autoRefreshInterval)*100;
    bar.style.width=pct+'%';
  }
}

async function autoAnalyze(){
  if(!isRegistered)return;
  var sym=document.getElementById('selSymbol').value;
  var tf=document.getElementById('selTF').value;
  if(!sym)return;
  try{
    var r=await fetch(API+'/api/analyze3/'+sym+'/'+tf);
    if(!r.ok)return;
    currentData=await r.json();
    lastAnalysisTime=new Date();
    // Save scroll position before re-render
    var scrollY=window.scrollY||window.pageYOffset;
    renderAnalysis(currentData);
    // Restore scroll position after re-render (prevent page jumping)
    window.scrollTo(0,scrollY);
    if(currentData.triggered_alerts){
      for(var ta of currentData.triggered_alerts){
        showToast(ta.icon||'\uD83D\uDD14',ta.title,ta.body,7000);
      }
    }
  }catch(e){}
}

// Pause auto-refresh when tab is hidden, resume when visible (without scrolling)
document.addEventListener('visibilitychange',function(){
  if(document.hidden){
    stopAutoRefresh();
  } else {
    if(autoRefreshEnabled && lastAnalysisTime) startAutoRefresh();
  }
});

// Start auto-refresh after first manual analyze
var origDoAnalyze=doAnalyze;
doAnalyze=async function(){
  await origDoAnalyze();
  lastAnalysisTime=new Date();
  if(autoRefreshEnabled)startAutoRefresh();
};

// â•â•â•â•â•â• TIMESTAMP HELPERS â•â•â•â•â•â•
function getLocalTimeStr(){
  var now=new Date();
  return String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0')+':'+String(now.getSeconds()).padStart(2,'0');
}

function getTimeSince(startTime){
  if(!startTime)return '';
  var now=new Date();
  var diff=Math.floor((now-startTime)/1000);
  if(diff<60)return diff+'\u062B \u067E\u06CC\u0634';
  if(diff<3600)return Math.floor(diff/60)+'\u062F \u067E\u06CC\u0634';
  return Math.floor(diff/3600)+'\u0633 \u067E\u06CC\u0634';
}


var origDoMulti=doMulti;
doMulti=async function(){
  await origDoMulti();
  lastAnalysisTime=new Date();
  if(autoRefreshEnabled)startAutoRefresh();
};

init();
</script>

<div id="strategy-widget" style="position:fixed;bottom:12px;left:12px;background:#12151c;border:1px solid #2a2f42;border-radius:10px;padding:10px 14px;z-index:90;font-size:11px;min-width:180px;">
  <div style="font-size:12px;font-weight:700;color:#a78bfa;margin-bottom:6px;">ğŸ”§ Strategy Builder</div>
  <div id="sw-content" style="color:#7f849c;">Loading...</div>
</div>
<script>
(function(){
  var email=localStorage.getItem('whilber_email')||'';
  if(!email)return;
  fetch('/api/builder/dashboard-widget?email='+encodeURIComponent(email))
    .then(function(r){return r.json();})
    .then(function(d){
      var box=document.getElementById('sw-content');
      if(!box)return;
      var html='';
      html+='<div>Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒâ€ŒÙ‡Ø§: <b style="color:#06b6d4;">'+d.total_strategies+'</b></div>';
      html+='<div>Ù…Ø§Ù†ÛŒØªÙˆØ± ÙØ¹Ø§Ù„: <b style="color:#22c55e;">'+d.active_monitors+'</b></div>';
      if(d.unread_alerts>0) html+='<div>Ø¢Ù„Ø±Øª Ø¬Ø¯ÛŒØ¯: <b style="color:#ef4444;">'+d.unread_alerts+'</b></div>';
      html+='<a href="/builder" style="color:#a78bfa;font-size:10px;">ÙˆØ±ÙˆØ¯ â†’</a>';
      box.innerHTML=html;
    })
    .catch(function(){});
})();
</script>


<script>
// Auto-inject manage buttons into strategy cards
(function(){
  function addManageButtons(){
    var cards=document.querySelectorAll('.signal-card, .strategy-card, .card-body .setup-card, [data-signal]');
    cards.forEach(function(card){
      if(card.querySelector('.manage-btn'))return;
      var signal=card.getAttribute('data-signal')||'';
      var symbol=card.getAttribute('data-symbol')||'XAUUSD';
      var tp=card.getAttribute('data-tp')||0;
      var sl=card.getAttribute('data-sl')||0;
      var entry=card.getAttribute('data-entry')||0;
      var name=card.getAttribute('data-name')||'Strategy';
      if(!signal)return;
      var btn=document.createElement('button');
      btn.className='manage-btn';
      btn.textContent='ğŸ›¡ï¸ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù†';
      btn.onclick=function(e){e.stopPropagation();openRiskManage(name,symbol,signal,parseFloat(tp),parseFloat(sl),parseFloat(entry));};
      var header=card.querySelector('.card-head, .setup-head, .signal-head');
      if(header)header.appendChild(btn);
      else card.appendChild(btn);
    });
  }
  // Run after page loads and after each refresh
  setTimeout(addManageButtons,2000);
  setInterval(addManageButtons,10000);
  var observer=new MutationObserver(function(){setTimeout(addManageButtons,500);});
  observer.observe(document.body,{childList:true,subtree:true});
})();
</script>


<!-- Risk Score Widget -->
<div class="risk-score-widget" id="riskScoreWidget" style="display:none;">
  <div class="rs-circle" id="rsCircle">--</div>
  <div class="rs-label" id="rsLabel">Risk Score</div>
  <div style="font-size:8px;color:#565a6e;margin-top:2px;" id="rsDetail"></div>
</div>

<!-- Alert Popup -->
<div class="alert-popup" id="alertPopup"></div>

<!-- Floating Trade Management Panel -->
<div class="rm-floating" id="riskLivePanel">
  <div class="rm-float-head" onclick="toggleRiskPanel()">
    <h4>ğŸ›¡ï¸ Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø¹Ø§Ù…Ù„Ø§Øª ÙØ¹Ø§Ù„ <span id="rmTradeCount" style="font-size:10px;color:#7f849c;"></span></h4>
    <div style="display:flex;gap:6px;align-items:center;">
      <span id="rmTotalPnl" style="font-weight:700;font-size:13px;"></span>
      <button onclick="event.stopPropagation();refreshRiskPanel()" style="background:#1a1e2a;border:1px solid #2a2f42;color:#06b6d4;padding:3px 8px;border-radius:5px;font-size:10px;cursor:pointer;">ğŸ”„</button>
      <span style="font-size:16px;color:#7f849c;" id="rmToggleIcon">â–²</span>
    </div>
  </div>
  <div class="rm-float-body" id="rmFloatBody"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RISK MANAGER â€” DEEP DASHBOARD INTEGRATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
var rmEmail=localStorage.getItem('whilber_email')||'';
var rmPanelOpen=false;
var rmRefreshTimer=null;
var rmAlertTimer=null;

// â”€â”€ INIT â”€â”€
function rmInit(){
  if(!rmEmail)return;
  injectManageButtons();
  loadRiskScore();
  loadRiskPanel();
  startAutoRefresh();
  // Re-inject on DOM changes
  var obs=new MutationObserver(function(){setTimeout(injectManageButtons,300);});
  obs.observe(document.body,{childList:true,subtree:true});
}

// â”€â”€ MANAGE BUTTONS â”€â”€
function injectManageButtons(){
  // Find all strategy/setup cards and inject manage button
  var selectors=[
    '[data-signal]',
    '.signal-card','.strategy-card','.setup-card',
    '.card[data-symbol]',
    '.result-card','.trade-card',
  ];
  var cards=document.querySelectorAll(selectors.join(','));
  cards.forEach(function(card){
    if(card.querySelector('.manage-btn-v2'))return;

    // Extract data from card attributes or content
    var signal=card.getAttribute('data-signal')||extractSignal(card);
    var symbol=card.getAttribute('data-symbol')||extractSymbol(card);
    var tp=card.getAttribute('data-tp')||extractPrice(card,'tp');
    var sl=card.getAttribute('data-sl')||extractPrice(card,'sl');
    var entry=card.getAttribute('data-entry')||extractPrice(card,'entry');
    var name=card.getAttribute('data-name')||extractName(card);

    if(!symbol&&!signal)return;

    var btn=document.createElement('button');
    btn.className='manage-btn-v2';
    btn.innerHTML='ğŸ›¡ï¸ Ù…Ø¯ÛŒØ±ÛŒØª';
    btn.onclick=function(e){
      e.stopPropagation();
      e.preventDefault();
      openTradeManage(name||symbol,symbol||'XAUUSD',signal||'BUY',
        parseFloat(tp)||0,parseFloat(sl)||0,parseFloat(entry)||0);
    };

    // Insert button
    var header=card.querySelector('.card-head,.setup-head,.signal-head,.result-head');
    if(header){
      header.style.display='flex';
      header.style.alignItems='center';
      header.style.gap='4px';
      header.appendChild(btn);
    }else{
      card.style.position='relative';
      btn.style.position='absolute';
      btn.style.top='6px';
      btn.style.left='6px';
      card.appendChild(btn);
    }
  });
}

function extractSignal(card){
  var t=card.textContent||'';
  if(t.indexOf('BUY')>-1||t.indexOf('Ø®Ø±ÛŒØ¯')>-1)return 'BUY';
  if(t.indexOf('SELL')>-1||t.indexOf('ÙØ±ÙˆØ´')>-1)return 'SELL';
  return '';
}
function extractSymbol(card){
  var m=(card.textContent||'').match(/(XAUUSD|EURUSD|GBPUSD|USDJPY|BTCUSD|US30|NAS100|XAGUSD|AUDUSD|USDCAD|NZDUSD|USDCHF)/);
  return m?m[1]:'';
}
function extractPrice(card,type){
  var t=card.textContent||'';
  var patterns={
    'tp':[/TP[:\s]*([0-9.]+)/i,/Ø­Ø¯ Ø³ÙˆØ¯[:\s]*([0-9.]+)/],
    'sl':[/SL[:\s]*([0-9.]+)/i,/Ø­Ø¯ Ø¶Ø±Ø±[:\s]*([0-9.]+)/],
    'entry':[/Entry[:\s]*([0-9.]+)/i,/ÙˆØ±ÙˆØ¯[:\s]*([0-9.]+)/],
  };
  for(var p of (patterns[type]||[])){var m=t.match(p);if(m)return m[1];}
  return '0';
}
function extractName(card){
  var h=card.querySelector('h3,h4,.card-title,.strategy-name');
  return h?(h.textContent||'').trim().substring(0,50):'';
}

// â”€â”€ OPEN TRADE MANAGE â”€â”€
window.openTradeManage=function(name,symbol,signal,tp,sl,entry){
  if(typeof openRiskManage==='function'){
    openRiskManage(name,symbol,signal,tp,sl,entry);
    return;
  }
  // Fallback: redirect to risk manager with params
  var params='?symbol='+symbol+'&direction='+signal;
  if(entry)params+='&entry='+entry;
  if(tp)params+='&tp='+tp;
  if(sl)params+='&sl='+sl;
  if(name)params+='&name='+encodeURIComponent(name);
  openRiskManage(name||symbol,symbol||'XAUUSD',signal||'BUY',parseFloat(tp)||0,parseFloat(sl)||0,parseFloat(entry)||0);
};

// â”€â”€ RISK SCORE WIDGET â”€â”€
function loadRiskScore(){
  fetch('/api/risk/score',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:rmEmail})})
  .then(function(r){return r.json();})
  .then(function(d){
    var w=document.getElementById('riskScoreWidget');
    if(!d.score&&d.score!==0)return;
    w.style.display='block';
    var c=document.getElementById('rsCircle');
    c.textContent=d.score;
    c.style.borderColor=d.color;
    c.style.color=d.color;
    document.getElementById('rsLabel').textContent=d.label_fa;
    document.getElementById('rsDetail').textContent=d.open_trades+' Ù…Ø¹Ø§Ù…Ù„Ù‡ | $'+(d.total_risk||0);

    // Show warnings as alerts
    if(d.warnings){
      for(var w of d.warnings){
        if(w.type==='critical')showAlertPopup(w.text_fa,'','critical');
      }
    }
  }).catch(function(){});
}

// â”€â”€ FLOATING PANEL â”€â”€
function loadRiskPanel(){
  fetch('/api/risk/portfolio',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:rmEmail})})
  .then(function(r){return r.json();})
  .then(function(d){
    var trades=d.trades||[];
    var panel=document.getElementById('riskLivePanel');
    var countEl=document.getElementById('rmTradeCount');
    var pnlEl=document.getElementById('rmTotalPnl');

    if(!trades.length){
      panel.classList.remove('show');
      return;
    }
    panel.classList.add('show');
    countEl.textContent='('+trades.length+' Ù…Ø¹Ø§Ù…Ù„Ù‡)';
    pnlEl.textContent=(d.total_pnl>=0?'+':'')+d.total_pnl+'$';
    pnlEl.style.color=d.total_pnl>=0?'#22c55e':'#ef4444';

    var body=document.getElementById('rmFloatBody');
    var html='<div class="rm-float-trades">';

    for(var t of trades){
      var pColor=t.pnl>=0?'#22c55e':'#ef4444';
      html+='<div class="rm-ft">';
      html+='<div class="rm-ft-head">';
      html+='<span class="rm-ft-badge '+(t.direction==='BUY'?'buy':'sell')+'">'+t.direction+'</span>';
      html+='<span class="rm-ft-sym">'+t.symbol+'</span>';
      if(t.strategy_name)html+='<span style="font-size:9px;color:#a78bfa;">'+t.strategy_name+'</span>';
      html+='<span class="rm-ft-pnl" style="color:'+pColor+';">'+(t.pnl>=0?'+':'')+t.pnl+'$ ('+t.pnl_pips+'p)</span>';
      html+='</div>';

      // Progress bar
      var prog=50;
      if(t.pnl>=0)prog=Math.min(90,50+t.pnl_pips/2);
      else prog=Math.max(10,50+t.pnl_pips/2);
      html+='<div class="rm-ft-bar"><div class="rm-ft-fill" style="width:'+prog+'%;background:'+pColor+';"></div></div>';

      // Quick info
      html+='<div style="display:flex;gap:8px;font-size:9px;color:#7f849c;">';
      html+='<span>ÙˆØ±ÙˆØ¯: '+t.entry+'</span>';
      html+='<span>ÙØ¹Ù„ÛŒ: '+t.current_price+'</span>';
      html+='<span>'+t.lot_size+' lot</span>';
      html+='</div>';

      // Fetch live recommendation
      html+='<div id="rmReco_'+t.id+'" class="rm-ft-reco low">â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...</div>';

      // Action buttons
      html+='<div style="display:flex;gap:4px;margin-top:4px;">';
      html+='<button onclick="window.location.href=\'/risk-manager\'" style="padding:2px 6px;border-radius:3px;background:rgba(6,182,212,.08);border:1px solid rgba(6,182,212,.2);color:#06b6d4;font-size:9px;cursor:pointer;">Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù…Ù„</button>';
      html+='</div>';
      html+='</div>';
    }
    html+='</div>';

    // Portfolio summary bar
    var rs=d.risk_score||{};
    html+='<div style="display:flex;gap:12px;margin-top:8px;padding:6px 10px;background:#12151c;border-radius:6px;font-size:10px;align-items:center;">';
    html+='<span>Risk Score: <b style="color:'+(rs.color||'#7f849c')+';">'+(rs.score||'--')+'</b></span>';
    html+='<span>Ø¨Ø§Ù„Ø§Ù†Ø³: <b>$'+d.balance+'</b></span>';
    html+='<span>Ø§Ú©ÙˆØ¦ÛŒØªÛŒ: <b style="color:'+(d.total_pnl>=0?'#22c55e':'#ef4444')+';">$'+d.equity+'</b></span>';
    html+='<span>Ø±ÛŒØ³Ú©: <b style="color:#f59e0b;">$'+(rs.total_risk||0)+' ('+(rs.total_risk_pct||0)+'%)</b></span>';
    if(rs.warnings){for(var w of rs.warnings.slice(0,2)){html+='<span style="color:'+(w.type==='critical'?'#ef4444':'#f59e0b')+';">'+w.text_fa+'</span>';}}
    html+='</div>';

    body.innerHTML=html;

    // Load live recommendations for each trade
    for(var t of trades){fetchTradeReco(t);}
  }).catch(function(){});
}

function fetchTradeReco(trade){
  fetch('/api/risk/trade/live',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({trade:trade})})
  .then(function(r){return r.json();})
  .then(function(d){
    var el=document.getElementById('rmReco_'+trade.id);
    if(!el||!d.success)return;
    var recs=d.recommendations||[];
    if(recs.length){
      var r=recs[0];
      el.className='rm-ft-reco '+(r.priority||'low');
      el.textContent=r.icon+' '+r.title_fa;
      el.title=r.detail_fa;
    }else{
      el.className='rm-ft-reco low';
      el.textContent='â³ ØµØ¨Ø± Ú©Ù†ÛŒØ¯';
    }
  }).catch(function(){});
}

window.toggleRiskPanel=function(){
  rmPanelOpen=!rmPanelOpen;
  var body=document.getElementById('rmFloatBody');
  body.style.display=rmPanelOpen?'block':'none';
  document.getElementById('rmToggleIcon').textContent=rmPanelOpen?'â–¼':'â–²';
};

window.refreshRiskPanel=function(){
  loadRiskPanel();
  loadRiskScore();
  checkAlerts();
};

// â”€â”€ ALERT SYSTEM â”€â”€
function checkAlerts(){
  fetch('/api/risk/alert/check',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:rmEmail})})
  .then(function(r){return r.json();})
  .then(function(d){
    if(d.triggered>0){
      for(var a of (d.alerts||[])){
        showAlertPopup(a.message_fa,a.action_fa,a.priority);
      }
    }
  }).catch(function(){});
}

function showAlertPopup(msg,action,priority){
  var popup=document.getElementById('alertPopup');
  var div=document.createElement('div');
  div.className='alert-item '+(priority||'high');
  div.innerHTML='<div class="ai-msg">'+msg+'</div>'+(action?'<div class="ai-action">'+action+'</div>':'');
  div.onclick=function(){div.remove();};
  popup.appendChild(div);
  setTimeout(function(){if(div.parentNode)div.remove();},8000);
}

// â”€â”€ AUTO REFRESH â”€â”€
function startAutoRefresh(){
  // Refresh panel every 5 seconds
  rmRefreshTimer=setInterval(function(){
    loadRiskPanel();
    loadRiskScore();
  },5000);
  // Check alerts every 10 seconds
  rmAlertTimer=setInterval(checkAlerts,10000);
}

// â”€â”€ START â”€â”€
setTimeout(rmInit,1500);
})();
</script>


<!-- â•â•â• Inline Risk Manage Modal â•â•â• -->
<div id="riskManageModal">
  <div class="rm-content">
    <div class="rm-top">
      <h3 id="rmTitle">ğŸ›¡ï¸ Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÛŒØ³Ú© Ø³ØªØ§Ù¾</h3>
      <button class="rm-close" onclick="closeRiskModal()">âœ•</button>
    </div>
    <div class="rm-body">
      <!-- Strategy Info -->
      <div class="rm-info-bar" id="rmInfoBar"></div>

      <!-- Editable Fields -->
      <div class="rm-form">
        <div class="rmf"><label>ğŸ’± Ù†Ù…Ø§Ø¯</label><input type="text" id="rmSymbol" readonly></div>
        <div class="rmf"><label>â†•ï¸ Ø¬Ù‡Øª</label><input type="text" id="rmDirection" readonly></div>
        <div class="rmf"><label>ğŸ”µ Ù‚ÛŒÙ…Øª ÙˆØ±ÙˆØ¯</label><input type="number" id="rmEntry" step="any" placeholder="Ù‚ÛŒÙ…Øª ÙˆØ±ÙˆØ¯"></div>
        <div class="rmf"><label>ğŸ“¡ Ù‚ÛŒÙ…Øª Ø²Ù†Ø¯Ù‡</label><input type="text" id="rmLivePrice" readonly style="color:#06b6d4;"></div>
      </div>
      <div class="rm-form">
        <div class="rmf"><label>ğŸ”´ Ø­Ø¯ Ø¶Ø±Ø± (SL)</label><input type="number" id="rmSL" step="any" placeholder="SL Ø§Ù„Ø²Ø§Ù…ÛŒ"></div>
        <div class="rmf"><label>ğŸŸ¢ Ø­Ø¯ Ø³ÙˆØ¯ Û± (TP1)</label><input type="number" id="rmTP1" step="any" placeholder="TP1"></div>
        <div class="rmf"><label>ğŸŸ¢ Ø­Ø¯ Ø³ÙˆØ¯ Û² (TP2)</label><input type="number" id="rmTP2" step="any" placeholder="Ø§Ø®ØªÛŒØ§Ø±ÛŒ"></div>
        <div class="rmf"><label>ğŸŸ¢ Ø­Ø¯ Ø³ÙˆØ¯ Û³ (TP3)</label><input type="number" id="rmTP3" step="any" placeholder="Ø§Ø®ØªÛŒØ§Ø±ÛŒ"></div>
      </div>

      <button class="rm-calc-btn" onclick="calcRiskInline()">ğŸ§® Ù…Ø­Ø§Ø³Ø¨Ù‡ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª</button>

      <!-- Results (inline) -->
      <div class="rm-results" id="rmResults"></div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INLINE RISK MANAGE â€” NO PAGE REDIRECT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var _rmStrategyName='';

function openRiskManage(name,symbol,signal,tp,sl,entry){
  _rmStrategyName=name||symbol||'';
  var modal=document.getElementById('riskManageModal');
  modal.classList.add('show');
  document.getElementById('rmTitle').textContent='ğŸ›¡ï¸ Ù…Ø¯ÛŒØ±ÛŒØª: '+_rmStrategyName;

  // Info bar
  document.getElementById('rmInfoBar').innerHTML=
    '<span class="ri-badge '+(signal==='BUY'?'buy':'sell')+'">'+signal+'</span>'+
    '<span style="font-weight:600;color:#e2e5f0;">'+symbol+'</span>'+
    '<span style="color:#7f849c;font-size:10px;">'+_rmStrategyName+'</span>';

  // Fill fields
  document.getElementById('rmSymbol').value=symbol||'XAUUSD';
  document.getElementById('rmDirection').value=signal||'BUY';
  document.getElementById('rmEntry').value=entry||'';
  document.getElementById('rmSL').value=sl||'';
  document.getElementById('rmTP1').value=tp||'';
  document.getElementById('rmTP2').value='';
  document.getElementById('rmTP3').value='';
  document.getElementById('rmLivePrice').value='...';
  document.getElementById('rmResults').innerHTML='<div style="text-align:center;color:#565a6e;padding:15px;font-size:11px;">TP Ùˆ SL Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ Ùˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨Ø²Ù†ÛŒØ¯</div>';

  // Fetch live price
  fetchLivePriceRM(symbol,signal);
}

function closeRiskModal(){
  document.getElementById('riskManageModal').classList.remove('show');
}

// Close on backdrop click
document.addEventListener('click',function(e){
  var modal=document.getElementById('riskManageModal');
  if(e.target===modal)closeRiskModal();
});

async function fetchLivePriceRM(symbol,direction){
  try{
    var r=await fetch('/api/risk/live-price',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({symbol:symbol})});
    var d=await r.json();
    if(d.success){
      var price=direction==='BUY'?d.ask:d.bid;
      document.getElementById('rmLivePrice').value=price+' ('+(direction==='BUY'?'Ask':'Bid')+')';
      if(!document.getElementById('rmEntry').value)document.getElementById('rmEntry').value=price;
    }else{
      document.getElementById('rmLivePrice').value='MT5 Ù…ØªØµÙ„ Ù†ÛŒØ³Øª';
    }
  }catch(e){document.getElementById('rmLivePrice').value='Ø®Ø·Ø§';}
}

async function calcRiskInline(){
  var symbol=document.getElementById('rmSymbol').value;
  var direction=document.getElementById('rmDirection').value;
  var entry=parseFloat(document.getElementById('rmEntry').value)||0;
  var sl=parseFloat(document.getElementById('rmSL').value)||0;
  var tp1=parseFloat(document.getElementById('rmTP1').value)||0;
  var tp2=parseFloat(document.getElementById('rmTP2').value)||0;
  var tp3=parseFloat(document.getElementById('rmTP3').value)||0;

  if(!entry){
    document.getElementById('rmResults').innerHTML='<div style="color:#ef4444;text-align:center;padding:10px;">âš ï¸ Ù‚ÛŒÙ…Øª ÙˆØ±ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>';
    return;
  }
  if(!sl){
    document.getElementById('rmResults').innerHTML='<div style="color:#ef4444;text-align:center;padding:10px;">âš ï¸ Ø­Ø¯ Ø¶Ø±Ø± (SL) Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª!</div>';
    return;
  }

  var box=document.getElementById('rmResults');
  box.innerHTML='<div style="text-align:center;color:#06b6d4;padding:15px;">ğŸ§® Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡...</div>';

  var email=localStorage.getItem('whilber_email')||'';

  try{
    var r=await fetch('/api/risk/from-strategy',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        email:email,strategy_name:_rmStrategyName,
        symbol:symbol,signal_type:direction,
        entry:entry,sl:sl,tp:tp1,
      })
    });
    var d=await r.json();
    if(d.success){
      d.tp2_price=tp2;d.tp3_price=tp3;
      renderInlineResults(d);
    }else{
      box.innerHTML='<div style="color:#ef4444;text-align:center;padding:10px;">'+(d.error||'Ø®Ø·Ø§')+'</div>';
    }
  }catch(e){box.innerHTML='<div style="color:#ef4444;text-align:center;">Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø·</div>';}
}

function renderInlineResults(d){
  var box=document.getElementById('rmResults');
  var html='';

  // â”€â”€ Key Stats â”€â”€
  html+='<div class="rm-stat-grid">';
  html+='<div class="rm-stat"><div class="rv" style="color:#06b6d4;">'+d.lot_size+'</div><div class="rl">Ø­Ø¬Ù… (Ù„Ø§Øª)<br>Ø¨Ø± Ø§Ø³Ø§Ø³ Ø±ÛŒØ³Ú© Ùˆ SL</div></div>';
  html+='<div class="rm-stat"><div class="rv" style="color:#ef4444;">$'+Math.abs(d.pnl.sl)+'</div><div class="rl">Ø±ÛŒØ³Ú© ($)<br>'+d.risk.pct_actual+'% Ø¨Ø§Ù„Ø§Ù†Ø³</div></div>';
  html+='<div class="rm-stat"><div class="rv" style="color:#22c55e;">$'+(d.pnl.tp1||0)+'</div><div class="rl">Ø³ÙˆØ¯ TP1<br>R:R = '+(d.rr.tp1||0)+'</div></div>';
  html+='<div class="rm-stat"><div class="rv" style="color:#f59e0b;">'+(d.pips?d.pips.sl:'--')+'</div><div class="rl">ÙØ§ØµÙ„Ù‡ SL<br>(Ù¾ÛŒÙ¾)</div></div>';
  html+='<div class="rm-stat"><div class="rv" style="color:#22c55e;">'+(d.pips?d.pips.tp1:'--')+'</div><div class="rl">ÙØ§ØµÙ„Ù‡ TP1<br>(Ù¾ÛŒÙ¾)</div></div>';
  html+='<div class="rm-stat"><div class="rv" style="color:#06b6d4;">$'+d.margin+'</div><div class="rl">Ù…Ø§Ø±Ø¬ÛŒÙ†<br>'+d.margin_pct+'%</div></div>';
  html+='<div class="rm-stat"><div class="rv" style="color:#7f849c;">'+d.be_price+'</div><div class="rl">Break Even<br>Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ø³Ù¾Ø±Ø¯</div></div>';
  html+='<div class="rm-stat"><div class="rv" style="color:#f59e0b;">$'+d.spread_cost+'</div><div class="rl">Ù‡Ø²ÛŒÙ†Ù‡ Ø§Ø³Ù¾Ø±Ø¯</div></div>';
  html+='</div>';

  // â”€â”€ Daily risk remaining â”€â”€
  if(d.risk&&d.risk.daily_remaining_pct!==undefined){
    var pct=d.risk.daily_remaining_pct;
    var clr=pct>50?'#22c55e':pct>20?'#f59e0b':'#ef4444';
    html+='<div style="margin-bottom:10px;padding:6px 8px;background:#1a1e2a;border-radius:6px;font-size:10px;">';
    html+='<span style="color:#7f849c;">Ø±ÛŒØ³Ú© Ø±ÙˆØ²Ø§Ù†Ù‡ Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡:</span> <span style="color:'+clr+';font-weight:700;">$'+d.risk.daily_remaining+' ('+pct+'%)</span>';
    html+='<div style="height:4px;background:#2a2f42;border-radius:2px;margin-top:3px;"><div style="height:100%;width:'+(100-pct)+'%;background:'+clr+';border-radius:2px;"></div></div>';
    html+='</div>';
  }

  // â”€â”€ Warnings â”€â”€
  if(d.warnings&&d.warnings.length){
    html+='<div class="rm-section">';
    for(var w of d.warnings)html+='<div class="rm-warning">'+w+'</div>';
    html+='</div>';
  }

  // â”€â”€ Milestones â”€â”€
  if(d.milestones&&d.milestones.length){
    html+='<div class="rm-section"><div class="rm-section-title">ğŸ—ºï¸ Ù†Ù‚Ø´Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø¹Ø§Ù…Ù„Ù‡</div>';
    for(var m of d.milestones){
      var icon=m.stage==='entry'?'ğŸŸ¢':m.stage==='sl'?'ğŸ”´':m.stage==='break_even'?'ğŸŸ¡':'ğŸ¯';
      html+='<div class="rm-milestone"><div class="rm-dot">'+icon+'</div><div>';
      html+='<div class="rm-ms-stage">'+m.stage_fa+'</div>';
      html+='<div class="rm-ms-price">Ù‚ÛŒÙ…Øª: '+m.price+'</div>';
      html+='<div class="rm-ms-action">'+m.action_fa+'</div>';
      html+='<div class="rm-ms-detail">'+m.detail_fa+'</div>';
      html+='</div></div>';
    }
    html+='</div>';
  }

  // â”€â”€ Partial Plan â”€â”€
  if(d.partial_plan&&d.partial_plan.length){
    html+='<div class="rm-section"><div class="rm-section-title">ğŸ’° Ù¾Ù„Ù† Ø³ÛŒÙˆ Ø³ÙˆØ¯</div>';
    for(var p of d.partial_plan){
      html+='<div class="rm-partial"><span class="rp-level">'+p.level+'</span><span class="rp-pct">'+p.close_pct+'%</span>';
      html+='<span style="color:#06b6d4;">@ '+p.price+'</span>';
      html+='<span style="color:#7f849c;">R:R='+p.rr+'</span>';
      html+='<span style="color:#565a6e;margin-right:auto;font-size:9px;">'+p.action_fa+'</span></div>';
    }
    html+='</div>';
  }

  // â”€â”€ Trailing â”€â”€
  if(d.trailing&&d.trailing.length){
    html+='<div class="rm-section"><div class="rm-section-title">ğŸ”„ ØªÙˆØµÛŒÙ‡ Trailing</div>';
    for(var t of d.trailing){
      html+='<div class="rm-trailing"><div class="rt-name">'+t.method_fa+'</div>';
      html+='<div class="rt-val">Ù…Ù‚Ø¯Ø§Ø±: '+t.value+'</div>';
      html+='<div class="rt-desc">'+t.desc_fa+'</div>';
      html+='<div style="font-size:9px;color:#f59e0b;margin-top:2px;">â° '+t.when_fa+'</div></div>';
    }
    html+='</div>';
  }

  // â”€â”€ Swap â”€â”€
  if(d.swap){
    html+='<div class="rm-swap">ğŸ”„ Ø³ÙˆØ§Ù¾ Ø´Ø¨Ø§Ù†Ù‡ ('+(d.direction==='BUY'?'Ø®Ø±ÛŒØ¯':'ÙØ±ÙˆØ´')+'): <b style="color:'+(d.swap.daily_cost>=0?'#22c55e':'#ef4444')+';">$'+d.swap.daily_cost+'/Ø´Ø¨</b></div>';
  }

  // â”€â”€ Tips â”€â”€
  if(d.tips&&d.tips.length){
    html+='<div class="rm-section" style="margin-top:8px;">';
    for(var tip of d.tips)html+='<div class="rm-tip">'+tip+'</div>';
    html+='</div>';
  }

  // â”€â”€ Symbol Notes â”€â”€
  if(d.symbol_info&&d.symbol_info.notes_fa){
    html+='<div class="rm-tip" style="margin-top:4px;">ğŸ“Œ '+d.symbol_info.notes_fa+'</div>';
  }

  box.innerHTML=html;
}
</script>


<div class="tb-tooltip" id="tbTooltip"></div>

<script>
// â•â•â•â•â•â• TRACK RECORD BADGES â•â•â•â•â•â•
(function(){
var _badgeCache={};
var _badgeTimer=null;

function loadAllBadges(){
  fetch('/api/fast/summary')
  .then(function(r){return r.json();})
  .then(function(d){
    _badgeCache={};
    (d.strategies||[]).forEach(function(s){
      _badgeCache[s.strategy_id]=s;
      // Also map by name for fallback matching
      if(s.strategy_name)_badgeCache['name_'+s.strategy_name.toLowerCase().trim()]=s;
    });
    injectBadges();
  }).catch(function(){});
}

function injectBadges(){
  var cards=document.querySelectorAll('[data-strategy-id],[data-name],.signal-card,.strategy-card,.setup-card,.card[data-signal]');
  cards.forEach(function(card){
    if(card.querySelector('.track-badge'))return;

    // Find strategy ID
    var sid=card.getAttribute('data-strategy-id')||'';
    var name=(card.getAttribute('data-name')||extractCardName(card)||'').toLowerCase().trim();

    var stats=_badgeCache[sid]||_badgeCache['name_'+name];
    if(!stats&&!sid&&!name)return;

    var badge=document.createElement('span');
    badge.className='track-badge trackBadge';

    if(stats&&stats.total>=1){
      var wr=stats.win_rate||0;
      var cls=wr>=60?'good':wr>=45?'mid':'bad';
      badge.className+=' '+cls;
      badge.innerHTML=wr+'% <span style="color:inherit;opacity:.6;">'+stats.total+'tr</span>';

      // Last results dots
      if(stats.last_5&&stats.last_5.length){
        badge.innerHTML+=' <span class="tb-dots">';
        stats.last_5.slice(0,3).forEach(function(t){
          badge.innerHTML+='<span class="tb-dot" style="background:'+(t.outcome==='win'?'#22c55e':'#ef4444')+';"></span>';
        });
        badge.innerHTML+='</span>';
      }

      badge.onmouseenter=function(e){showBadgeTooltip(e,stats);};
      badge.onmouseleave=hideBadgeTooltip;
      badge.onclick=function(e){
        e.stopPropagation();
        window.open('/track-record#'+encodeURIComponent(stats.strategy_id),'_blank');
      };
    }else{
      badge.className+=' none';
      badge.textContent='-- Ø³Ø§Ø¨Ù‚Ù‡';
      badge.title='Ù‡Ù†ÙˆØ² Ø³Ø§Ø¨Ù‚Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡';
    }

    var header=card.querySelector('.card-head,.setup-head,.signal-head,.result-head');
    if(header){
      header.style.display='flex';
      header.style.alignItems='center';
      header.style.gap='4px';
      header.appendChild(badge);
    }else{
      card.style.position='relative';
      badge.style.position='absolute';
      badge.style.top='4px';
      badge.style.right='4px';
      card.appendChild(badge);
    }
  });
}

function extractCardName(card){
  var h=card.querySelector('h3,h4,.card-title,.strategy-name');
  return h?(h.textContent||'').trim().substring(0,60):'';
}

function showBadgeTooltip(e,stats){
  var tt=document.getElementById('tbTooltip');
  var html='<div style="font-weight:700;color:#06b6d4;margin-bottom:4px;">'+stats.strategy_name+'</div>';
  html+='<div class="tt-row"><span class="tt-label">Ù…Ø¹Ø§Ù…Ù„Ø§Øª:</span><span class="tt-val">'+stats.total+'</span></div>';
  html+='<div class="tt-row"><span class="tt-label">Win Rate:</span><span class="tt-val" style="color:'+(stats.win_rate>=60?'#22c55e':stats.win_rate>=45?'#f59e0b':'#ef4444')+';">'+stats.win_rate+'%</span></div>';
  html+='<div class="tt-row"><span class="tt-label">Ø³ÙˆØ¯ Ú©Ù„:</span><span class="tt-val" style="color:'+(stats.total_pnl>=0?'#22c55e':'#ef4444')+';">'+(stats.total_pnl>=0?'+':'')+stats.total_pnl+'$</span></div>';
  html+='<div class="tt-row"><span class="tt-label">Ù†Ù…Ø§Ø¯:</span><span class="tt-val">'+stats.symbol+'</span></div>';
  if(stats.last_trade)html+='<div class="tt-row"><span class="tt-label">Ø¢Ø®Ø±ÛŒÙ†:</span><span class="tt-val" style="font-size:9px;">'+stats.last_trade.substring(0,10)+'</span></div>';
  html+='<div style="font-size:8px;color:#565a6e;margin-top:3px;">Ú©Ù„ÛŒÚ© â†’ Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ù…Ù„</div>';
  tt.innerHTML=html;
  tt.style.display='block';
  tt.style.top=(e.clientY+12)+'px';
  tt.style.left=(e.clientX-120)+'px';
}

function hideBadgeTooltip(){
  document.getElementById('tbTooltip').style.display='none';
}

// Load on page ready + refresh periodically
setTimeout(loadAllBadges,2000);
setInterval(loadAllBadges,30000);

// Re-inject on DOM changes
var obs=new MutationObserver(function(){setTimeout(injectBadges,400);});
obs.observe(document.body,{childList:true,subtree:true});
})();
</script>


<!-- Toast Container -->
<div class="notif-toast-container" id="toastContainer"></div>

<script>
// â•â•â•â•â•â• NOTIFICATION TOAST SYSTEM â•â•â•â•â•â•
(function(){
  var _email = localStorage.getItem('whilber_email') || '';
  var _lastCount = 0;
  var _toastQueue = [];
  var API = window.location.origin;

  // Add bell to nav
  function addBell(){
    var nav = document.querySelector('.nav, nav, [class*="nav"], header');
    if(!nav) return;
    var bell = document.createElement('span');
    bell.className = 'dash-bell';
    bell.innerHTML = 'ğŸ””<span class="db-count" id="dashBellCount" style="display:none;">0</span>';
    bell.onclick = function(){ window.open('/track-record','_blank'); };
    bell.title = 'Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ â€” Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ø³ÙˆØ§Ø¨Ù‚';
    nav.appendChild(bell);
  }

  function showToast(notif){
    var container = document.getElementById('toastContainer');
    if(!container) return;
    var div = document.createElement('div');
    div.className = 'notif-toast';
    div.innerHTML = '<span class="nt-icon">'+(notif.icon||'ğŸ””')+'</span>'
      +'<div class="nt-body">'
      +'<div class="nt-title">'+(notif.title_fa||'Ù‡Ø´Ø¯Ø§Ø±')+'</div>'
      +'<div class="nt-detail">'+(notif.strategy_name||'')+' | '+(notif.symbol||'')+' '+(notif.direction||'')
      +(notif.action_fa?'\n'+notif.action_fa:'')+'</div>'
      +'</div>'
      +'<button class="nt-close" onclick="this.parentElement.classList.add('closing');setTimeout(function(){this.parentElement.remove()}.bind(this),300);">âœ•</button>';
    container.appendChild(div);
    // Auto dismiss after 8 sec
    setTimeout(function(){
      if(div.parentElement){
        div.classList.add('closing');
        setTimeout(function(){if(div.parentElement)div.remove();},300);
      }
    }, 8000);
  }

  async function pollNotifs(){
    if(!_email) return;
    try{
      var r = await fetch(API+'/api/alert/unread-count?email='+encodeURIComponent(_email));
      var d = await r.json();
      var cnt = d.count || 0;
      var badge = document.getElementById('dashBellCount');
      if(badge){
        if(cnt>0){badge.style.display='inline';badge.textContent=cnt;}
        else badge.style.display='none';
      }
      // If new notifs arrived, show toast
      if(cnt > _lastCount && _lastCount >= 0){
        var diff = cnt - _lastCount;
        var r2 = await fetch(API+'/api/alert/notifications?email='+encodeURIComponent(_email)+'&limit='+diff+'&unread=true');
        var d2 = await r2.json();
        (d2.notifications||[]).forEach(function(n){ showToast(n); });
      }
      _lastCount = cnt;
    }catch(e){}
  }

  // Ask for email if not set
  function checkEmail(){
    if(!_email){
      // Try to get from page
      var emailEl = document.querySelector('[data-email]');
      if(emailEl) _email = emailEl.dataset.email;
      if(!_email){
        _email = 'user@whilber.ai';
        localStorage.setItem('whilber_email', _email);
      }
    }
  }

  setTimeout(function(){
    checkEmail();
    addBell();
    pollNotifs();
    setInterval(pollNotifs, 10000);
  }, 2000);
})();
</script>

<script src="/static/alert_system.js"></script>
<script src="/static/live_status.js"></script>
<script src="/static/perf.js"></script>
<script src="/static/dashboard_tracklink.js"></script>
<script src="/static/notif.js"></script>
<script src="/static/alert-modal.js"></script>
<!-- â•â•â• UNIVERSAL FOOTER â•â•â• -->
<!-- â•â•â• CHART PANEL (hidden until analyze) â•â•â• -->
<div class="wchart-wrapper" id="wChartWrapper" style="display:none;">
  <div class="wchart-panel" id="wChartPanel">
    <div class="wchart-header">
      <div class="wchart-title">
        <span>ğŸ“ˆ</span>
        <span class="sym" id="wChartSymbol">â€”</span>
        <span class="tf-badge" id="wChartTF">H1</span>
        <span class="trade-badge" id="wChartTradeBadge" style="display:none;"></span>
      </div>
      <div class="wchart-controls" id="wChartTFBtns">
        <button onclick="wChartSetTF('M1')">M1</button>
        <button onclick="wChartSetTF('M5')">M5</button>
        <button onclick="wChartSetTF('M15')">M15</button>
        <button onclick="wChartSetTF('M30')">M30</button>
        <button onclick="wChartSetTF('H1')" class="active">H1</button>
        <button onclick="wChartSetTF('H4')">H4</button>
        <button onclick="wChartSetTF('D1')">D1</button>
        <button onclick="wChartToggleTrades()" title="Ø³ÙˆØ§Ø¨Ù‚ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒâ€ŒÙ‡Ø§" style="margin-right:4px;">ğŸ“Š</button>
        <button onclick="wChartToggleMAs()" title="Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†â€ŒÙ‡Ø§" style="margin-right:4px;">ğŸ“</button>
        <button onclick="wChartClose()" title="Ø¨Ø³ØªÙ† Ú†Ø§Ø±Øª" style="color:#ef4444;">âœ•</button>
      </div>
    </div>
    <div class="wchart-body" id="wChartContainer">
      <div class="wchart-legend">
        <span><div class="dot" style="background:#22c55e;"></div> Ø®Ø±ÛŒØ¯</span>
        <span><div class="dot" style="background:#ef4444;"></div> ÙØ±ÙˆØ´</span>
        <span><div class="dot" style="background:#06b6d4;"></div> ÙˆØ±ÙˆØ¯</span>
        <span><div class="dot" style="background:#a855f7;"></div> Ø®Ø±ÙˆØ¬</span>
      </div>
    </div>
    <div id="wSetupInfo" style="display:none;padding:0 10px 10px;"></div>
  </div>
</div>
<!-- â•â•â• END CHART â•â•â• -->

<footer class="wfooter">
  <div class="wfooter-grid">
    <div class="wfooter-brand">
      <a href="/" style="display:flex;align-items:center;gap:8px;text-decoration:none;">
        <div style="width:28px;height:28px;background:linear-gradient(135deg,#00d4ff,#a855f7);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:900;color:#fff;">W</div>
        <span style="font-size:16px;font-weight:800;background:linear-gradient(135deg,#00d4ff,#a855f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">Whilber-AI</span>
      </a>
      <p>Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ ØªØ­Ù„ÛŒÙ„ Ø¨Ø§Ø²Ø§Ø±Ù‡Ø§ÛŒ Ù…Ø§Ù„ÛŒ. ØªØ­Ù„ÛŒÙ„ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ ÙØ§Ø±Ú©Ø³ØŒ Ú©Ø±ÛŒÙ¾ØªÙˆØŒ ÙÙ„Ø²Ø§Øª Ùˆ Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§.</p>
    </div>
    <div class="wfooter-col">
      <h4>Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§</h4>
      <a href="/dashboard">ğŸ“Š ØªØ­Ù„ÛŒÙ„ Ø¨Ø§Ø²Ø§Ø±</a>
      <a href="/track-record">ğŸ“œ Ø³ÙˆØ§Ø¨Ù‚</a>
      <a href="/builder">ğŸ”§ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒâ€ŒØ³Ø§Ø²</a>
      <a href="/risk-manager">ğŸ›¡ï¸ Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÛŒØ³Ú©</a>
      <a href="/journal">ğŸ“’ Ú˜ÙˆØ±Ù†Ø§Ù„</a>
      <a href="/alerts">ğŸ”” Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§</a>
      <a href="/performance">&#x1F4C8; Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø²Ù†Ø¯Ù‡</a>
    </div>
    <div class="wfooter-col">
      <h4>Ø§Ø·Ù„Ø§Ø¹Ø§Øª</h4>
      <a href="/guide">ğŸ“– Ø±Ø§Ù‡Ù†Ù…Ø§</a>
      <a href="/services">â­ Ø®Ø¯Ù…Ø§Øª</a>
    <a href="/about">ğŸ‘¤ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§</a>
      <a href="/contact">ğŸ“ ØªÙ…Ø§Ø³</a>
      <a href="/">ğŸ  ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ</a>
    </div>
    <div class="wfooter-col">
      <h4>Ø§Ø±ØªØ¨Ø§Ø·</h4>
      <a href="https://t.me/WhilberAI" target="_blank">âœˆï¸ Ú©Ø§Ù†Ø§Ù„ ØªÙ„Ú¯Ø±Ø§Ù…</a>
      <a href="mailto:support@whilber-ai.com">ğŸ“§ Ø§ÛŒÙ…ÛŒÙ„</a>
      <a href="/contact">ğŸ’¬ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</a>
      <a href="/admin">âš™ï¸ Ø§Ø¯Ù…ÛŒÙ†</a>
    </div>
  </div>
  <div class="wfooter-bottom">
    <p>Â© 2026 Whilber-AI â€” ØªÙ…Ø§Ù…ÛŒ Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸ Ø§Ø³Øª. ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§ Ø¬Ù†Ø¨Ù‡ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø¯Ø§Ø±Ù†Ø¯ Ùˆ ØªÙˆØµÛŒÙ‡ Ù…Ø§Ù„ÛŒ Ù†ÛŒØ³ØªÙ†Ø¯.</p>
    <div style="display:flex;gap:8px;">
      <a href="https://t.me/WhilberAI" target="_blank">âœˆï¸ ØªÙ„Ú¯Ø±Ø§Ù…</a>
      <a href="mailto:support@whilber-ai.com">ğŸ“§ Ø§ÛŒÙ…ÛŒÙ„</a>
    </div>
  </div>
</footer>


<!-- â•â•â• CHART ENGINE â•â•â• -->
<script src="/static/chart_engine.js"></script>







<script>
/* â•â•â• Chart Bridge v3 â€” Hidden until analyze â•â•â• */
(function(){
var _chartReady = false;
var _wShowTrades = true;
var _wShowMAs = true;

function _symEl(){
  return document.getElementById("symbolSelect")||document.getElementById("symbol")||document.getElementById("sym")||document.querySelector("select[name*='symbol']")||document.querySelector("select");
}
function _tfEl(){
  var e=document.getElementById("tfSelect")||document.getElementById("timeframe")||document.getElementById("tf")||document.querySelector("select[name*='time']");
  if(!e){var a=document.querySelectorAll("select");if(a.length>1)e=a[1];}return e;
}
function _sym(){
  var e=_symEl();if(!e)return"XAUUSD";
  var v=e.value||"";v=v.replace(/[\u0600-\u06FF\s\-\(\)]/g,"").trim().toUpperCase();
  if(!v&&e.selectedIndex>=0)v=(e.options[e.selectedIndex].text||"").replace(/[\u0600-\u06FF\s\-\(\)]/g,"").trim().toUpperCase();
  return v||"XAUUSD";
}
function _tf(){var e=_tfEl();return e?e.value.toUpperCase():"H1";}
function _header(s,t){
  var h=document.getElementById("wChartSymbol"),b=document.getElementById("wChartTF");
  if(h)h.textContent=s;if(b)b.textContent=t;
  var btns=document.querySelectorAll("#wChartTFBtns button:not([title])");
  btns.forEach(function(b){b.classList.toggle("active",b.textContent.trim()===t);});
}

// Show chart panel
function _showChart(sym, tf){
  var w=document.getElementById("wChartWrapper");
  if(!w)return;
  w.style.display="block";
  sym=sym||_sym();tf=tf||_tf();
  _header(sym,tf);
  if(!_chartReady){
    WhilberChart.init("wChartContainer",sym,tf);
    _chartReady=true;
  } else {
    WhilberChart.update(sym,tf);
  }
  // Do NOT scroll to chart automatically â€” prevents page jumping on auto-refresh/tab return
}

// Close chart
window.wChartClose=function(){
  var w=document.getElementById("wChartWrapper");
  if(w)w.style.display="none";
};

// TF buttons
window.wChartSetTF=function(tf){
  _header(_sym(),tf);
  if(window.WhilberChart){
    WhilberChart.update(null,tf);
    if(_wShowMAs&&WhilberChart.loadMAs)WhilberChart.loadMAs(_sym(),tf);
  }
  var te=_tfEl();
  if(te){for(var i=0;i<te.options.length;i++){if(te.options[i].value.toUpperCase()===tf){te.selectedIndex=i;break;}}}
};

// Toggle trades
window.wChartToggleTrades=function(){
  _wShowTrades=!_wShowTrades;
  if(_wShowTrades&&WhilberChart){var st=WhilberChart.getState();WhilberChart.loadTrades(st.symbol,st.tf);}
};

// Toggle MAs
window.wChartToggleMAs=function(){
  _wShowMAs=!_wShowMAs;
  if(WhilberChart.toggleMAs)WhilberChart.toggleMAs();
};

// â”€â”€ Intercept fetch: show chart on analyze â”€â”€
var _oFetch=window.fetch;
window.fetch=function(){
  var url=(arguments[0]||"").toString();
  return _oFetch.apply(this,arguments).then(function(resp){
    // ANALYZE â†’ show chart + signals
    if(url.indexOf("/api/analyze3/")!==-1){
      // Extract symbol from URL
      var parts=url.split("/api/analyze3/");
      var urlSym=(parts[1]||"").split(/[?\/]/)[0].toUpperCase();
      
      resp.clone().json().then(function(data){
        if(!window.WhilberChart)return;
        var sym=urlSym||_sym();
        var tf=_tf();
        
        // Show chart for this symbol
        _showChart(sym,tf);
        
        // Signal on chart
        var ov=data.overall||data;
        var sig=(ov.signal||ov.direction||"").toUpperCase();
        var conf=Math.round(ov.confidence||ov.agreement||0);
        if(WhilberChart.showSignalZone)WhilberChart.showSignalZone(sig,conf);
        
        // MAs
        if(_wShowMAs&&WhilberChart.loadMAs)setTimeout(function(){WhilberChart.loadMAs(sym,tf);},300);
        
        // Best setup â€” check s.setup (nested) and master_setup
        var strats=data.strategies||data.results||[];
        var best=null,bestC=0;
        for(var i=0;i<strats.length;i++){
          var s=strats[i];
          var su=s.setup||{};
          var sEntry=su.entry||s.entry||s.entry_price||0;
          var sSl=su.stop_loss||s.sl||s.stop_loss||0;
          var sTp=su.tp1||s.tp||s.tp1||s.take_profit||0;
          var sTp2=su.tp2||s.tp2||0;
          var sConf=s.confidence||s.score||0;
          if(sEntry&&su.has_setup&&sConf>bestC){
            bestC=sConf;
            best={strategy:s.strategy_name_fa||s.strategy_name||s.strategy_id||"",direction:su.direction||s.signal||sig,
              entry:sEntry,sl:sSl,tp:sTp,tp2:sTp2,
              confidence:Math.round(bestC),win_rate:s.win_rate||s.wr||0};
          }
        }
        // Prefer master_setup if available â€” it has aggregated levels
        var ms=data.master_setup;
        if(ms&&ms.has_setup){
          best={strategy:"Ø³ØªØ§Ù¾ Ú©Ù„ÛŒ",direction:ms.direction,
            entry:ms.entry,sl:ms.stop_loss,tp:ms.tp1,tp2:ms.tp2,
            confidence:ms.confidence,win_rate:0};
        }
        if(best&&WhilberChart.showSetup)WhilberChart.showSetup(best);
        // Show setup info panel below chart
        var infoEl=document.getElementById("wSetupInfo");
        if(infoEl&&best){
          var dc=best.direction==="BUY"?"var(--green)":"var(--red)";
          infoEl.style.display="block";
          infoEl.innerHTML='<div style="display:flex;gap:12px;flex-wrap:wrap;font-size:11px;padding:6px 0;border-top:1px solid var(--border);align-items:center;"><span style="font-weight:700;color:'+dc+';">'+best.strategy+' â€” '+best.direction+'</span><span>ğŸ¯ '+best.entry+'</span><span style="color:var(--red);">ğŸ›‘ '+best.sl+'</span><span style="color:var(--green);">âœ… '+best.tp+'</span>'+(best.tp2?'<span style="color:var(--green);">ğŸ† '+best.tp2+'</span>':'')+'<span>'+best.confidence+'%</span></div>';
        } else if(infoEl){infoEl.style.display="none";}
        
        // Trades
        if(_wShowTrades)setTimeout(function(){WhilberChart.loadTrades(sym,tf);},500);
      }).catch(function(){});
    }
    // MULTI analyze â†’ show chart for first symbol
    if(url.indexOf("/api/multi/")!==-1){
      resp.clone().json().then(function(data){
        // Just show chart is available, user can click analyze per symbol
      }).catch(function(){});
    }
    // Price â†’ current price line
    if(url.indexOf("/api/price/")!==-1){
      resp.clone().json().then(function(data){
        if(data&&(data.bid||data.price)&&WhilberChart&&WhilberChart.updateCurrentPrice){
          WhilberChart.updateCurrentPrice(data.bid||data.price);
        }
      }).catch(function(){});
    }
    return resp;
  });
};

})();
</script>

<!-- â•â•â• Plan-Aware Dashboard Logic (Phase 5) â•â•â• -->
<script>
document.addEventListener('whilber-plan-ready', function(e){
  var P = window.WHILBER_PLAN; if(!P) return;
  var L = P.limits, U = P.usage;

  // Daily progress bar
  var bar = document.getElementById('planDailyBar');
  if(bar && P.loggedIn){
    bar.innerHTML = planProgress(U.analyses_today||0, L.analyses_per_day||5, '\u062A\u062D\u0644\u06CC\u0644 \u0627\u0645\u0631\u0648\u0632');
  }

  // Limit reached â†’ show upsell immediately
  if(P.loggedIn && L.analyses_per_day && U.analyses_today >= L.analyses_per_day){
    if(typeof showUpsell === 'function') showUpsell('\u0638\u0631\u0641\u06CC\u062A \u062A\u062D\u0644\u06CC\u0644 \u0631\u0648\u0632\u0627\u0646\u0647 \u062A\u0645\u0627\u0645 \u0634\u062F\u0647 \u0627\u0633\u062A. \u0628\u0631\u0627\u06CC \u062A\u062D\u0644\u06CC\u0644 \u0628\u06CC\u0634\u062A\u0631\u060C \u067E\u0644\u0646 \u062E\u0648\u062F \u0631\u0627 \u0627\u0631\u062A\u0642\u0627 \u062F\u0647\u06CC\u062F');
  }

  // Grey out restricted symbols
  var symSel = document.getElementById('selSymbol');
  if(symSel && L.symbols && Array.isArray(L.symbols)){
    var opts = symSel.querySelectorAll('option');
    for(var i=0; i<opts.length; i++){
      var v = opts[i].value;
      if(v && L.symbols.indexOf(v) === -1){
        opts[i].disabled = true;
        opts[i].textContent = opts[i].textContent + ' \uD83D\uDD12';
      }
    }
  }

  // Grey out restricted timeframes
  var tfSel = document.getElementById('selTF');
  if(tfSel && L.timeframes && Array.isArray(L.timeframes)){
    var tfOpts = tfSel.querySelectorAll('option');
    for(var j=0; j<tfOpts.length; j++){
      var tv = tfOpts[j].value;
      if(tv && L.timeframes.indexOf(tv) === -1){
        tfOpts[j].disabled = true;
        tfOpts[j].textContent = tv + ' \uD83D\uDD12';
      }
    }
  }

  // Plan sidebar widget
  var main = document.querySelector('.main');
  if(main && P.loggedIn){
    var w = document.createElement('div');
    w.id = 'planWidget';
    w.className = 'plan-widget';
    var symCount = (L.symbols && Array.isArray(L.symbols)) ? L.symbols.length : '\u221E';
    var tfCount = (L.timeframes && Array.isArray(L.timeframes)) ? L.timeframes.length : '\u221E';
    w.innerHTML = '<div class="plan-widget-head"><h4>\uD83D\uDCCA \u067E\u0644\u0646 \u0634\u0645\u0627</h4>' + planBadge(P.plan) + '</div>' +
      planProgress(U.analyses_today||0, L.analyses_per_day||5, '\u062A\u062D\u0644\u06CC\u0644 \u0631\u0648\u0632\u0627\u0646\u0647') +
      '<div class="plan-widget-stats">' +
        '<div class="pw-stat"><div class="pwv">' + (L.max_strategies||32) + '</div><div class="pwl">\u0627\u0633\u062A\u0631\u0627\u062A\u0698\u06CC</div></div>' +
        '<div class="pw-stat"><div class="pwv">' + symCount + '</div><div class="pwl">\u0646\u0645\u0627\u062F</div></div>' +
        '<div class="pw-stat"><div class="pwv">' + tfCount + '</div><div class="pwl">\u062A\u0627\u06CC\u0645\u0641\u0631\u06CC\u0645</div></div>' +
        '<div class="pw-stat"><div class="pwv">' + (U.active_alerts||0) + '/' + (L.max_alerts||2) + '</div><div class="pwl">\u0647\u0634\u062F\u0627\u0631</div></div>' +
      '</div>' +
      (P.plan === 'free' ? '<div style="text-align:center;margin-top:10px;"><a href="/pricing" class="wnav-upgrade">\u2B06 \u0627\u0631\u062A\u0642\u0627 \u067E\u0644\u0646</a></div>' : '');
    main.insertBefore(w, main.firstChild);
  }
});

// Post-analysis: update daily progress bar with fresh plan_info
var _origRenderAnalysis = window.renderAnalysis;
if(typeof _origRenderAnalysis === 'function'){
  window.renderAnalysis = function(data){
    _origRenderAnalysis(data);
    if(data && data.plan_info){
      var bar = document.getElementById('planDailyBar');
      if(bar) bar.innerHTML = planProgress(data.plan_info.daily_used||0, data.plan_info.daily_limit||5, '\u062A\u062D\u0644\u06CC\u0644 \u0627\u0645\u0631\u0648\u0632');
    }
  };
}
</script>

</body>
</html>
